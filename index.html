<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>èŒå® æˆç»©å…»æˆè®° - æ•™å¸ˆç«¯</title>
    <!-- ä¿æŒä½ çš„æœ¬åœ°å¼•ç”¨ -->
    <script src="js/xlsx.full.min.js"></script>
    <style>
        /* ================== å‘½ç†å–œç«åœŸå®šåˆ¶æ ·å¼ (æœ€ç»ˆå°Šäº«ç‰ˆ) ================== */
        :root {
            --primary: #FF6B6B;
            --primary-gradient: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%);
            --bg: #FFF9F0;
            --text: #5D4037;
            --white: #ffffff;
            --shadow: 0 8px 20px rgba(255, 107, 107, 0.15);
            --radius: 16px;
            --green: #4ECDC4;
            --red-alert: #FF5252;
        }

        body {
            font-family: 'Nunito', 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0; padding: 20px; height: 100vh; box-sizing: border-box;
            display: flex; flex-direction: column;
            background-image: radial-gradient(#FFE0B2 1px, transparent 1px);
            background-size: 20px 20px;
        }

        /* é¡¶éƒ¨ */
        .header {
            display: flex; justify-content: space-between; align-items: center;
            background: var(--white); padding: 15px 25px; border-radius: var(--radius);
            box-shadow: var(--shadow); margin-bottom: 20px; flex-wrap: wrap; gap: 15px;
            border-left: 6px solid #FF6B6B;
        }
        .header h1 { 
            margin: 0; font-size: 24px; font-weight: 800; white-space: nowrap; 
            background: var(--primary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }

        .btn-group { display: flex; flex-wrap: wrap; gap: 10px; }
        .btn-group button {
            background: var(--primary-gradient); color: white; border: none; padding: 10px 18px;
            border-radius: 50px; cursor: pointer; font-weight: bold; font-size: 13px;
            transition: all 0.3s ease; white-space: nowrap; box-shadow: 0 4px 10px rgba(255, 107, 107, 0.3);
            display: flex; justify-content: center; align-items: center;
        }
        .btn-group button:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(255, 107, 107, 0.4); }
        .btn-blue { background: linear-gradient(135deg, #FFB75E 0%, #ED8F03 100%) !important; box-shadow: 0 4px 10px rgba(237, 143, 3, 0.3) !important; }
        .btn-purple { background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%) !important; box-shadow: 0 4px 10px rgba(161, 140, 209, 0.3) !important; }
        .btn-green { background: #4ECDC4 !important; }
        .btn-orange { background: linear-gradient(135deg, #FF9966 0%, #FF5E62 100%) !important; box-shadow: 0 4px 10px rgba(255, 94, 98, 0.3) !important; }

        /* å¸ƒå±€ */
        .main-container { display: flex; gap: 20px; flex: 1; overflow: hidden; min-height: 0; }

        /* å·¦ä¾§æ’è¡Œæ¦œ */
        .ranking-panel {
            width: 280px; background: var(--white); border-radius: var(--radius); box-shadow: var(--shadow);
            display: flex; flex-direction: column; overflow: hidden; flex-shrink: 0; border: 1px solid rgba(255,255,255,0.5);
        }
        .panel-header { padding: 18px; border-bottom: 2px dashed #FFEEE4; font-weight: bold; background: #fff; display: flex; justify-content: space-between; color: #FF6B6B; }
        .student-list { overflow-y: auto; flex: 1; padding: 15px; }
        .student-card {
            display: flex; align-items: center; padding: 12px 15px; margin-bottom: 10px;
            border-radius: 12px; background: #FFFBF7; border: 1px solid transparent; cursor: pointer; transition: 0.2s;
        }
        .student-card:hover { background-color: #FFF0F0; border-color: #FFCCBC; transform: translateX(3px); }
        .rank-badge { width: 28px; height: 28px; background: #FFE0B2; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 12px; font-weight: bold; color: #E65100; font-size: 12px; }
        .rank-1 { background: linear-gradient(135deg, #FFD700, #FFCA28); color: #fff; }
        .card-info { flex: 1; } .card-name { font-weight: bold; font-size: 15px; } .card-score { font-weight: bold; color: #FF6B6B; }

        /* å³ä¾§åˆ—è¡¨ */
        .list-panel {
            flex: 1; background: var(--white); border-radius: var(--radius); box-shadow: var(--shadow);
            display: flex; flex-direction: column; overflow: hidden; padding: 20px; min-width: 0; border: 1px solid rgba(255,255,255,0.5);
        }
        .data-table-container { flex: 1; overflow: auto; border-radius: 12px; border: 1px solid #FFEEE4; }
        .data-table { width: 100%; border-collapse: collapse; min-width: 600px; }
        
        /* è¡¨å¤´å±…ä¸­ */
        .data-table th { background: #FFEBEE; color: #C62828; padding: 15px; text-align: center; position: sticky; top: 0; z-index: 10; }
        /* è¡¨æ ¼å†…å®¹å±…ä¸­ */
        .data-table td { padding: 12px 15px; border-bottom: 1px solid #FFF3E0; vertical-align: middle; color: #5D4037; text-align: center; }
        
        .pet-avatar { width: 30px; height: 30px; object-fit: contain; vertical-align: middle; margin-right: 8px; font-size: 24px; display: inline-block; text-align: center; }
        .status-tag { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; background: #eee; color: #666; white-space: nowrap; font-weight: 600; }
        .status-tag.mid { background: #FFF3E0; color: #E65100; }
        .status-tag.high { background: #E8F5E9; color: #2E7D32; }

        .action-btn { background: #fff; border: 1px solid #FFCCBC; color: #FF7043; padding: 6px 14px; border-radius: 20px; cursor: pointer; font-size: 12px; transition: 0.2s; margin-right: 5px; white-space: nowrap; }
        .action-btn:hover { background: #FF7043; color: white; }
        
        /* ============== å¼¹çª—é€šç”¨ ============== */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(93, 64, 55, 0.4); backdrop-filter: blur(4px);
            z-index: 100; display: none; justify-content: center; align-items: center;
        }
        .modal {
            background: var(--white); padding: 30px; border-radius: 24px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.15); animation: slideIn 0.3s ease;
            position: relative; display: flex; flex-direction: column;
            max-height: 90vh; width: auto; max-width: 95vw; box-sizing: border-box; border: 4px solid #FFF3E0;
        }
        @keyframes slideIn { from {opacity: 0; transform: translateY(20px);} to {opacity: 1; transform: translateY(0);} }
        
        .modal-header { font-size: 22px; font-weight: 800; margin-bottom: 10px; border-bottom: 2px dashed #eee; padding-bottom: 10px; display: flex; justify-content: space-between; align-items: center; color: #5D4037; }
        .modal-title-badges { display: flex; align-items: center; gap: 10px; }
        .badge-small { font-size: 14px; background: var(--primary-gradient); color: white; padding: 4px 12px; border-radius: 20px; font-weight: normal; box-shadow: 0 2px 5px rgba(255,107,107,0.3); }
        .close-btn { cursor: pointer; color: #FFAB91; font-size: 28px; line-height: 22px; transition: 0.2s; }
        .close-btn:hover { color: #FF6B6B; transform: rotate(90deg); }

        /* ============== è¯¦æƒ…é¡µä¸“ç”¨ ============== */
        .detail-content { 
            display: flex; flex-direction: column; align-items: center; 
            overflow-y: auto; overflow-x: hidden;
            padding: 0 10px 10px 10px; box-sizing: border-box; width: 100%;
        }
        .pet-image-container {
            width: 100%; display: flex; justify-content: center; align-items: center;
            background: radial-gradient(circle, rgba(255, 230, 200, 0.6) 0%, rgba(255, 255, 255, 0) 70%); 
            padding: 10px; margin-bottom: 15px; border-radius: 50%;
        }
        .pet-stage-lg { 
            width: 240px; height: 240px; object-fit: contain; 
            filter: drop-shadow(0 10px 15px rgba(255,107,107,0.3)); 
            animation: floatBreath 3s ease-in-out infinite; 
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            cursor: pointer;
        }
        .pet-stage-lg:active { transform: scale(0.9); }
        @keyframes floatBreath { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        /* å¹¶æ’å¸ƒå±€ */
        .info-row { display: flex; gap: 15px; width: 100%; margin-bottom: 20px; box-sizing: border-box; }
        .info-half { flex: 1; display: flex; flex-direction: column; justify-content: center; height: 80px; box-sizing: border-box; min-width: 0; }

        .setting-box { background: #FFF3E0; padding: 10px 15px; border-radius: 12px; border: 1px solid #FFE0B2; }
        .exp-container { background: #FFF8E1; padding: 10px 15px; border-radius: 16px; border: 1px solid #FFE0B2; }
        .exp-bar-bg { background: #FFE0B2; height: 12px; border-radius: 10px; overflow: hidden; margin-top: 5px; }
        .exp-bar-fill { height: 100%; background: linear-gradient(90deg, #FF8A65, #FF5252); width: 0%; transition: width 0.6s ease-out; }
        
        .history-box { 
            width: 100%; border-top: 2px dashed #FFCCBC; padding-top: 20px; 
            flex: 1; overflow-y: auto; 
            min-height: 150px; 
            max-height: 200px; 
        }
        .history-item { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 10px 0; border-bottom: 1px solid #FFF3E0; font-size: 15px; color: #6D4C41; 
        }
        .history-item.revoked {
            text-decoration: line-through;
            color: #aaa !important;
        }
        .history-item.revoked span { color: #aaa !important; }

        .btn-revoke {
            background: #FFEBEE; color: #D32F2F; border: none; padding: 2px 8px; border-radius: 4px;
            font-size: 12px; cursor: pointer; margin-left: 10px;
        }
        .btn-revoke:hover { background: #FFCDD2; }
        
        /* ============== æ‰¹é‡å½•å…¥ä¸“ç”¨æ ·å¼ ============== */
        .batch-list-container {
            flex: 1; 
            overflow-y: auto; 
            border: 2px solid #FFEEE4; border-radius: 12px; margin-bottom: 15px;
            max-height: 500px; 
        }
        .batch-list-container .data-table th,
        .batch-list-container .data-table td {
            text-align: center !important; 
            padding: 6px 4px !important; 
            font-size: 14px; 
        }
        .batch-input.score-input {
            width: 100px !important; 
            height: 32px; 
            line-height: 32px;
            font-size: 14px;
            text-align: center;      
            margin: 0 auto;          
            display: block;
        }

        /* ============== è¿›é˜¶å›¾é‰´ä¸“ç”¨æ ·å¼ ============== */
        .gallery-group { width: 100%; margin-bottom: 25px; border-bottom: 1px dashed #FFCCBC; padding-bottom: 15px; }
        .gallery-title { font-weight: bold; color: #E65100; margin-bottom: 15px; font-size: 16px; border-left: 5px solid #FF6B6B; padding-left: 10px; background: #FFF3E0; padding: 8px 10px; border-radius: 0 10px 10px 0; }
        .gallery-row { display: flex; gap: 15px; overflow-x: auto; padding-bottom: 10px; justify-content: center; }
        .gallery-item { display: flex; flex-direction: column; align-items: center; min-width: 100px; position: relative; }
        .gallery-img { width: 80px; height: 80px; object-fit: contain; background: #fff; border: 2px solid #FFE0B2; border-radius: 12px; padding: 5px; margin-bottom: 8px; transition: transform 0.2s; }
        .gallery-img:hover { transform: scale(1.1); border-color: #FF6B6B; }
        .gallery-level { font-size: 12px; background: #FF6B6B; color: white; padding: 2px 8px; border-radius: 10px; margin-bottom: 4px; }
        .gallery-name { font-size: 13px; color: #5D4037; font-weight: bold; text-align: center; }
        .gallery-arrow { display: flex; align-items: center; color: #FFCCBC; font-size: 20px; font-weight: bold; }

        /* æ§ä»¶ */
        .form-group { margin-bottom: 15px; width: 100%; }
        .form-label { display: block; margin-bottom: 8px; color: #FF6B6B; font-weight: bold; font-size: 15px; }
        .form-input { width: 100%; height: 48px; padding: 0 12px; line-height: 48px; border: 2px solid #FFCCBC; border-radius: 12px; font-size: 15px; color: #5D4037; background: #FFFBF7; outline: none; box-sizing: border-box; }
        select.form-input { appearance: auto; cursor: pointer; padding-top: 0; padding-bottom: 0; }
        .form-input:focus { border-color: #FF6B6B; background: #fff; }
        .btn-submit { width: 100%; height: 48px; background: var(--primary-gradient); color: white; border: none; border-radius: 50px; cursor: pointer; font-size: 16px; font-weight: bold; display: flex; justify-content: center; align-items: center; margin-top: 15px; box-shadow: 0 5px 15px rgba(255,107,107,0.4); transition: all 0.2s; }
        .btn-submit:hover { transform: scale(1.02); }
        .config-info { font-size: 12px; color: #8D6E63; background: #FFF3E0; padding: 4px 10px; border-radius: 10px; margin-left: 10px; }
        .full-width-box { width: 100%; box-sizing: border-box; }

        @media (max-width: 768px) {
            body { padding: 10px; }
            .header { flex-direction: column; }
            .main-container { flex-direction: column; }
            .ranking-panel { width: 100%; height: 200px; }
            .modal-normal, .modal-lg { width: 95vw !important; }
            .info-row { flex-direction: column; height: auto; gap: 10px; } 
            .info-half { width: 100%; height: auto; padding: 15px; }
        }
        
        /* å‡çº§å¼¹çª—ä¸“ç”¨åŠ¨ç”» */
        @keyframes zoomBounce { 0% { transform: scale(0); opacity: 0; } 60% { transform: scale(1.2); opacity: 1; } 100% { transform: scale(1); } }
        #levelUpImgContainer { position: relative; }
        #levelUpImgContainer::after { content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 100%; height: 100%; border-radius: 50%; background: radial-gradient(circle, rgba(255,215,0,0.4) 0%, rgba(255,255,255,0) 70%); z-index: -1; animation: rotateLight 3s linear infinite; }
        
        /* ================= ç§¯åˆ†å•†åŸä¸“ç”¨æ ·å¼ ================= */
        .shop-container { display: flex; height: 500px; gap: 20px; }
        .shop-left { flex: 2; display: flex; flex-direction: column; border-right: 1px dashed #FFCCBC; padding-right: 15px; }
        .shop-goods-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 12px; overflow-y: auto; padding: 5px; align-content: start; flex: 1; }
        .good-card { background: #FFFBF7; border: 2px solid #FFE0B2; border-radius: 12px; padding: 10px; cursor: pointer; transition: all 0.2s; position: relative; display: flex; flex-direction: column; align-items: center; }
        .good-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(255,167,38,0.2); }
        .good-card.active { border-color: #FF6B6B; background: #FFF0F0; box-shadow: 0 0 0 2px rgba(255,107,107,0.3); }
        .good-icon { font-size: 32px; margin-bottom: 5px; }
        .good-name { font-weight: bold; font-size: 14px; text-align: center; color: #5D4037; margin-bottom: 4px; }
        .good-price { font-size: 13px; color: #E65100; font-weight: bold; background: #FFF3E0; padding: 2px 8px; border-radius: 10px; }
        .btn-del-good { position: absolute; top: 2px; right: 2px; color: #EF9A9A; cursor: pointer; display: none; font-size: 16px; }
        .good-card:hover .btn-del-good { display: block; }
        .good-card:hover .btn-del-good:hover { color: red; }
        .add-good-card { border: 2px dashed #FFCCBC; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #FF8A65; cursor: pointer; min-height: 100px; }
        .add-good-card:hover { border-color: #FF6B6B; background: #FFF; }
        .good-card.disabled { opacity: 0.4; cursor: not-allowed; filter: grayscale(100%); background: #eeeeee; border-color: #e0e0e0; pointer-events: none; }

        .shop-right { flex: 1.2; display: flex; flex-direction: column; background: #FAFAFA; border-radius: 12px; padding: 10px; overflow: hidden; }
        .shop-student-list { flex: 1; overflow-y: auto; overflow-x: hidden; padding: 2px; margin-bottom: 5px; }
        .shop-stu-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; background: white; border-radius: 8px; margin-bottom: 8px; border: 2px solid transparent; box-shadow: 0 1px 3px rgba(0,0,0,0.05); cursor: pointer; transition: all 0.2s ease; width: 100%; box-sizing: border-box; }
        .shop-stu-item:hover { background-color: #FFFBF7; border-color: #FFE0B2; }
        .shop-stu-item.selected { border-color: #FF6B6B; background-color: #FFF0F0; box-shadow: 0 4px 10px rgba(255, 107, 107, 0.15); position: relative; z-index: 1; }
        .shop-stu-item.disabled { opacity: 0.6; cursor: not-allowed; background: #f5f5f5; border-color: #eee; }
        .shop-stu-coin { color: #E65100; font-weight: bold; font-size: 13px; display: flex; align-items: center; gap: 5px; }
        .shop-footer { border-top: 1px solid #eee; padding-top: 12px; display: flex; justify-content: space-between; align-items: center; background: #FAFAFA; z-index: 5; flex-shrink: 0; }
        .btn-batch-buy { background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%); color: white; border: none; padding: 8px 20px; border-radius: 50px; cursor: pointer; font-weight: bold; box-shadow: 0 4px 10px rgba(255, 107, 107, 0.3); opacity: 0.5; pointer-events: none; transition: all 0.3s; font-size: 14px; }
        .btn-batch-buy.active { opacity: 1; pointer-events: auto; transform: scale(1.05); }

        /* æ—¥å¿—å¼¹çª—æ ·å¼ */
        .log-list { width: 100%; overflow-y: auto; }
		
		/*/* ================= é”å±ä¸“ç”¨æ ·å¼ (Tabç‰ˆ) ================= */
        /* ä¿®æ”¹é”å±èƒŒæ™¯é¢œè‰²ï¼šä½¿ç”¨æ·±æ£•è‰²é…åˆç£¨ç ‚ï¼Œä¸æ•´ä½“é£æ ¼ç»Ÿä¸€ */
        .lock-overlay {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            /* åŸæ¥æ˜¯è“è‰²ï¼Œç°åœ¨æ”¹ä¸ºæ·±æ£•è‰² (R93 G64 B55)ï¼Œé€æ˜åº¦0.4 */
            background: rgba(93, 64, 55, 0.4); 
            backdrop-filter: blur(10px); /* ç£¨ç ‚è´¨æ„Ÿ */
            z-index: 9999; display: none;
            flex-direction: column; justify-content: center; align-items: center;
            color: white; animation: fadeIn 0.3s;
        }
        .lock-box {
            background: white; padding: 30px; border-radius: 20px;
            text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            width: 340px; position: relative;
        }
        /* Tab æ ‡ç­¾æ  */
        .lock-tabs {
            display: flex; border-bottom: 2px solid #eee; margin-bottom: 20px;
        }
        .lock-tab-item {
            flex: 1; padding: 10px; cursor: pointer; color: #999; font-weight: bold;
            border-bottom: 3px solid transparent; transition: 0.3s;
        }
        .lock-tab-item.active {
            color: #FF6B6B; border-bottom-color: #FF6B6B;
        }
        /* å†…å®¹åŒº */
        .lock-content { display: none; animation: fadeIn 0.2s; }
        .lock-content.active { display: block; }

        .lock-avatar { font-size: 50px; margin-bottom: 15px; }
        .lock-input { 
            width: 100%; height: 44px; border: 2px solid #eee; border-radius: 8px; 
            text-align: center; font-size: 16px; margin-bottom: 15px; outline: none; transition: 0.3s;
            box-sizing: border-box; /* å…³é”®ï¼šé˜²æ­¢è¾“å…¥æ¡†æ’‘ç ´å®¹å™¨ */
        }
        .lock-input:focus { border-color: #FF6B6B; }
        .btn-unlock {
            width: 100%; height: 44px; border-radius: 50px; border: none;
            background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%);
            color: white; font-weight: bold; cursor: pointer;
            box-shadow: 0 4px 10px rgba(255,107,107,0.3);
        }
        .btn-change {
            width: 100%; height: 44px; border-radius: 50px; border: none;
            background: linear-gradient(135deg, #4ECDC4 0%, #26A69A 100%);
            color: white; font-weight: bold; cursor: pointer;
            box-shadow: 0 4px 10px rgba(78, 205, 196, 0.3);
        }
    </style>
</head>
<body>

    <div class="header">
        <h1 id="mainTitle">ğŸ”¥ èŒå® æˆç»©å…»æˆè®°</h1>
        <div class="btn-group">
			<button class="btn-orange" onclick="lockScreen()">ğŸ”’ æŒ‚æœºé”å±</button>
            <button class="btn-orange" onclick="openLogModal()">ğŸ“ æ“ä½œæ—¥å¿—</button>
            <button class="btn-purple" onclick="openGalleryModal()">ğŸ–¼ï¸ è¿›é˜¶å›¾é‰´</button>
            <button class="btn-green" onclick="openShopModal()">ğŸ ç§¯åˆ†å•†åŸ</button>
            <button class="btn-blue" onclick="downloadTemplateWithPicker()">ğŸ“¥ ä¸‹è½½ä¸“ç”¨æ¨¡æ¿</button>
            <button onclick="triggerImport()">ğŸ“‚ å¯¼å…¥Excel</button>
            <input type="file" id="importFile" hidden accept=".xlsx" onchange="handleImport(this)">
            <button onclick="openBatchModal()">âš¡ æ‰¹é‡å–‚å…»</button>
            <button onclick="exportDataWithPicker()">ğŸ’¾ ä¿å­˜è¿›åº¦</button>
        </div>
    </div>

    <div class="main-container">
        <div class="ranking-panel">
            <div class="panel-header"><span>ğŸ† ç§¯åˆ†Topæ¦œ</span><span style="font-size:12px;">Fighting!</span></div>
            <div class="student-list" id="rankingList"></div>
        </div>

        <div class="list-panel">
            <div class="panel-header">
                <div style="flex:1;"><span>ğŸ“‹ å…¨ç­æ¡£æ¡ˆ</span><span class="config-info" id="configDisplay"></span></div>
                <input type="text" id="searchInput" class="form-input" placeholder="ğŸ” æœå§“å" oninput="renderMainTable()" style="width: 150px; height: 40px; line-height: 40px; margin-bottom:0;">
            </div>
            <div class="data-table-container">
    <table class="data-table">
        <thead>
            <tr>
                <th width="50">æ’å</th>
                <th>å§“å</th>
                <th>å½¢æ€ç§°å·</th>
                <th>ç­‰çº§ / ç»éªŒè¿›åº¦</th>
                <th>å¯ç”¨ç§¯åˆ†</th>
                <th width="120">æ“ä½œ</th>
            </tr>
        </thead>
        <tbody id="mainTableBody"></tbody>
    </table>
</div>
        </div>
    </div>

    <!-- è¯¦æƒ…å¼¹çª— -->
    <div class="modal-overlay" id="detailModal">
        <div class="modal modal-normal" style="width: 600px;">
            <div class="modal-header">
                <div class="modal-title-badges"><span id="modalTitleText">è¯¦æƒ…</span></div>
                <span class="close-btn" onclick="closeModal('detailModal')">Ã—</span>
            </div>
            <div id="modalDetailContent" class="detail-content"></div>
        </div>
    </div>

    <!-- å•ä¸ªå–‚å…»å¼¹çª— -->
    <div class="modal-overlay" id="singleFeedModal">
        <div class="modal" style="width: 420px;">
            <div class="modal-header"><span>ğŸ¥• æŠ•å–‚ <span id="singleFeedName"></span></span><span class="close-btn" onclick="closeModal('singleFeedModal')">Ã—</span></div>
            <div style="padding: 10px 0;">
                <div class="form-group"><label class="form-label">ç§‘ç›® / åŸå› </label><select id="singleSubject" class="form-input"></select></div>
                <div class="form-group"><label class="form-label">åˆ†æ•° (æ”¯æŒè´Ÿæ•°)</label><input type="tel" id="singleScore" class="form-input" placeholder="è¾“å…¥åˆ†æ•°" oninput="this.value = this.value.replace(/[^0-9-]/g, '')"></div>
                <div class="form-group"><label class="form-label">æ—¥æœŸ</label><input type="date" id="singleDate" class="form-input"></div>
                <button class="btn-submit" onclick="submitSingleFeed()">ç¡®è®¤æŠ•å–‚</button>
            </div>
        </div>
    </div>

    <!-- æ‰¹é‡å–‚å…»å¼¹çª— -->
    <div class="modal-overlay" id="batchModal">
        <div class="modal" style="width: 700px;">
            <div class="modal-header">
                <div style="display: flex; align-items: center;">
                    <span>âš¡ æ‰¹é‡æˆç»©å½•å…¥</span>
                    <span class="config-info" style="margin-left: 10px; font-weight: normal;">enteræˆ–è€…å›è½¦è‡ªåŠ¨æ¢è¡Œ</span>
                </div>
                <span class="close-btn" onclick="closeModal('batchModal')">Ã—</span>
            </div>
            <div style="display: flex; gap: 10px; margin-bottom:15px;">
                <select id="batchSubject" class="form-input" style="width: 150px; flex:1; margin-bottom:0;"></select>
                <input type="date" id="batchDate" class="form-input" style="width: 150px; flex:1; margin-bottom:0;">
            </div>
            <div class="batch-list-container">
                <table class="data-table">
                    <thead><tr><th>å§“å</th><th>å½“å‰ç­‰çº§</th><th>æœ¬æ¬¡æˆç»©</th><th>é¢„è®¡ç§¯åˆ†</th></tr></thead>
                    <tbody id="batchTableBody"></tbody>
                </table>
            </div>
            <button class="btn-submit" onclick="submitBatchFeed()">ç¡®è®¤æ‰¹é‡å–‚å…»</button>
        </div>
    </div>

    <!-- å…¨æ ¡æ“ä½œæ—¥å¿—å¼¹çª— -->
    <div class="modal-overlay" id="logModal">
        <div class="modal" style="width: 750px; height: 600px;">
            <div class="modal-header">
                <span>ğŸ“ å…¨æ ¡æ“ä½œæ—¥å¿—</span>
                <span class="close-btn" onclick="closeModal('logModal')">Ã—</span>
            </div>
            <div class="log-list" id="logListContainer">
                <!-- JSå¡«å…… -->
            </div>
        </div>
    </div>

    <!-- è¿›é˜¶å›¾é‰´å¼¹çª— -->
    <div class="modal-overlay" id="galleryModal">
        <div class="modal modal-normal" style="width: 850px; max-height: 85vh;">
            <div class="modal-header"><span>ğŸ–¼ï¸ èŒå® è¿›é˜¶è·¯çº¿å›¾</span><span class="close-btn" onclick="closeModal('galleryModal')">Ã—</span></div>
            <div id="galleryContent" class="detail-content" style="align-items: flex-start; overflow-y: auto; width: 100%; box-sizing: border-box;">
                <!-- JSä¼šè‡ªåŠ¨å¡«å……è¿™é‡Œ -->
            </div>
        </div>
    </div>

    <!-- ç‚¹å‡»å¤§å›¾é¢„è§ˆé®ç½© -->
    <div id="imgPreviewOverlay" onclick="this.style.display='none'" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.1); z-index:9999; display:none; justify-content:center; align-items:center; cursor:zoom-out; backdrop-filter: blur(2px);">
        <img id="imgPreviewTarget" src="" style="max-width:90%; max-height:90%; border-radius:16px; box-shadow:0 0 30px rgba(255,255,255,0.2); animation: zoomIn 0.2s ease-out;">
    </div>

    <!-- å±…ä¸­æç¤ºæ¡† -->
    <div id="centerToast" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0, 0, 0, 0.8); color: white; padding: 20px 40px; border-radius: 12px; font-weight: bold; z-index: 3000; display: none; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
        <div style="font-size: 30px; margin-bottom: 10px;">ğŸ‰</div>
        <span id="toastMsg">æ“ä½œæˆåŠŸ</span>
    </div>

    <!-- å‡çº§ä¸“å±ç‰¹æ•ˆå¼¹çª— (å¤§å›¾ç‰ˆ) -->
    <div class="modal-overlay" id="levelUpModal" style="z-index: 2000;">
        <div class="modal" style="width: 500px; text-align: center; background: linear-gradient(135deg, #FFF 0%, #FFF8E1 100%); border: 4px solid #FFD700;">
            <div style="font-size: 24px; font-weight: 900; color: #FF6B6B; margin-bottom: 5px; text-shadow: 2px 2px 0px #FFE0B2;">
                ğŸ‰ æ­å–œ <span id="levelUpName" style="font-size: 30px; color:#E65100;"></span> åŒå­¦å‡çº§ï¼
            </div>
            <div id="levelUpImgContainer" style="margin: 5px auto 15px; width: 320px; height: 320px; display: flex; align-items: center; justify-content: center; animation: zoomBounce 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);"></div>
            <div style="background: #FFE0B2; color: #E65100; display: inline-block; padding: 4px 20px; border-radius: 50px; font-weight: bold; font-size: 16px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(255, 167, 38, 0.3);">
                è·å¾—ç§°å·ï¼š<span id="levelUpTitle"></span>
            </div>
            <button class="btn-submit" onclick="closeModal('levelUpModal')" style="background: linear-gradient(135deg, #FFD700 0%, #FFCA28 100%); box-shadow: 0 5px 15px rgba(255, 215, 0, 0.4);">å¤ªæ£’äº†ï¼(å…³é—­)</button>
        </div>
    </div>

    <!-- æ·»åŠ å•†å“ä¸“ç”¨å°å¼¹çª— -->
    <div class="modal-overlay" id="addProductModal" style="z-index: 2000;">
        <div class="modal" style="width: 350px;">
            <div class="modal-header">
                <span>ğŸ ä¸Šæ¶æ–°å•†å“</span>
                <span class="close-btn" onclick="closeModal('addProductModal')">Ã—</span>
            </div>
            <div style="padding: 15px 0;">
                <div class="form-group"><label class="form-label">å¥–å“åç§°</label><input type="text" id="newProdName" class="form-input" placeholder="ä¾‹å¦‚ï¼šå…ä½œä¸šå¡"></div>
                <div class="form-group"><label class="form-label">å…‘æ¢ç§¯åˆ†</label><input type="tel" id="newProdPrice" class="form-input" placeholder="è¾“å…¥æ•°å­—ï¼Œå¦‚ 500"></div>
                <button class="btn-submit" onclick="confirmAddProduct()">ç¡®è®¤ä¸Šæ¶</button>
            </div>
        </div>
    </div>

    <!-- ç§¯åˆ†å•†åŸå¼¹çª— -->
    <div class="modal-overlay" id="shopModal">
        <div class="modal" style="width: 850px; height: 650px;">
            <div class="modal-header">
                <span>ğŸ ç§¯åˆ†å…‘æ¢å•†åŸ</span>
                <span class="close-btn" onclick="closeModal('shopModal')">Ã—</span>
            </div>
            <div class="shop-container">
                <div class="shop-left">
                    <div style="font-weight:bold; color:#FF6B6B; margin-bottom:10px; display:flex; justify-content:space-between;">
                        <span>ğŸ›’ é€‰æ‹©å•†å“</span><span style="font-size:12px; color:#999;">ç‚¹å‡»ä¸‹æ–¹ + å·å¯æ·»åŠ æ–°å•†å“</span>
                    </div>
                    <div id="shopGoodsGrid" class="shop-goods-grid"></div>
                </div>
                <div class="shop-right">
                    <input type="text" id="shopSearchInput" class="form-input" placeholder="ğŸ” æœåå­—å¯å¤šé€‰..." style="height:36px; font-size:13px; margin-bottom: 5px;" oninput="renderShopStudents()">
                    <div id="shopStudentList" class="shop-student-list"></div>
                    <div class="shop-footer">
                        <div style="font-size: 13px; color: #666;">å·²é€‰: <span id="selectedCount" style="color:#FF6B6B; font-weight:bold; font-size:16px;">0</span> äºº</div>
                        <button id="btnBatchBuy" class="btn-batch-buy" onclick="submitBatchPurchase()">ç¡®è®¤å…‘æ¢</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
<!-- ç»Ÿä¸€é”å±é®ç½©å±‚ -->
    <div id="lockScreenOverlay" class="lock-overlay">
        <div class="lock-box">
            <!-- é¡¶éƒ¨ Tab åˆ‡æ¢ -->
            <div class="lock-tabs">
                <div class="lock-tab-item active" onclick="switchLockTab('unlock', this)">ğŸ”“ è§£é”</div>
                <div class="lock-tab-item" onclick="switchLockTab('change', this)">ğŸ”‘ ä¿®æ”¹å¯†ç </div>
            </div>

            <!-- 1. è§£é”é¢æ¿ -->
            <div id="panel-unlock" class="lock-content active">
                <div class="lock-avatar">ğŸ”’</div>
                <input type="password" id="unlockPwd" class="lock-input" placeholder="è¾“å…¥ç®¡ç†å¯†ç " onkeyup="if(event.key==='Enter') checkUnlock()">
                <button class="btn-unlock" onclick="checkUnlock()">è§£ é”</button>
            </div>

            <!-- 2. ä¿®æ”¹å¯†ç é¢æ¿ -->
            <div id="panel-change" class="lock-content">
                <div style="font-size:12px; color:#999; margin-bottom:10px;">ä¿®æ”¹å¯†ç åå°†è‡ªåŠ¨ä¿å­˜</div>
                <input type="password" id="oldPwdChange" class="lock-input" placeholder="å½“å‰æ—§å¯†ç ">
                <input type="text" id="newPwdChange" class="lock-input" placeholder="è®¾ç½®æ–°å¯†ç ">
                <button class="btn-change" onclick="doChangePassword()">ç¡®è®¤ä¿®æ”¹</button>
            </div>
        </div>
    </div>
    <script>
        // ================= æ•°æ®ä¸­å¿ƒ =================
        let students = []; 
        let products = [];
        let historyData = []; 
        let currentFeedName = ''; 
        let currentDetailName = ''; 
        let docTitle = 'èŒå® æˆç»©å…»æˆè®°'; 
        let isDataDirty = false; 

        let CONFIG = { 
            pointsPerLevel: 100, 
            expRate: 0.5,   // ç»éªŒæ¢ç®—æ¯”ä¾‹
            pointRate: 1.0,  // ç§¯åˆ†æ¢ç®—æ¯”ä¾‹
			password: "888888"  // <--- æ–°å¢è¿™ä¸€è¡Œï¼šé»˜è®¤å¯†ç ä¸ºç©º
        };

        let SUBJECT_LIST = ["è¯­æ–‡", "æ•°å­¦", "è‹±è¯­", "æ—¥å¸¸"];
        let EVOLUTION_RULES = [3, 6, 10, 20]; 
        
        let PET_LIBRARY = {
            "default": { images: ["ğŸ¥š", "ğŸ£", "ğŸ”", "ğŸ¦‰", "ğŸ²"], titles: ["ç¥ç§˜çš„è›‹", "å‘†èŒå°é¸¡", "æˆ˜æ–—å…¬é¸¡", "åšå­¦çŒ«å¤´é¹°", "ä¼ è¯´ç¥é¾™"] },
            "fire": { images: ["ğŸ”¥", "ğŸ¦", "ğŸ¦–", "ğŸ²", "ğŸŒ"], titles: ["åˆçº§ç«è‹—", "ç«ç„°èœ¥èœ´", "å–·ç«éœ¸é¾™", "çƒˆç„°ç¥é¾™", "å¤ªé˜³ç¥"] }
        };

        // å¼ºåŠ›æ—¶é—´æ ¼å¼åŒ–å‡½æ•° (ç²¾ç¡®åˆ°ç§’)
        function formatAnyTime(timeInput) {
            if (!timeInput && timeInput !== 0) return ""; 
            let date;
            if (timeInput instanceof Date) {
                date = timeInput;
            } else if (typeof timeInput === 'number') {
                date = new Date((timeInput - 25569) * 86400 * 1000); // å¤„ç†Excelæ—¥æœŸ
            } else if (typeof timeInput === 'string') {
                if(timeInput.includes('T')) date = new Date(timeInput);
                else date = new Date(timeInput.replace(/-/g, '/'));
            }
            
            if (!date || isNaN(date.getTime())) return String(timeInput);
            
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hh = String(date.getHours()).padStart(2, '0');
            const mm = String(date.getMinutes()).padStart(2, '0');
            const ss = String(date.getSeconds()).padStart(2, '0');
            return `${year}-${month}-${day} ${hh}:${mm}:${ss}`;
        }

        window.addEventListener('beforeunload', function (e) {
            if (isDataDirty) { e.preventDefault(); e.returnValue = ''; return ''; }
        });

        function getPetInfo(student) {
            let pathKey = student.petPath || "default"; 
            if (!PET_LIBRARY[pathKey]) pathKey = "default";
            const libraryItem = PET_LIBRARY[pathKey];
            const pathImages = libraryItem.images || [];
            const pathTitles = libraryItem.titles || [];
            let stageIndex = 0;
            for (let i = 0; i < EVOLUTION_RULES.length; i++) { if (student.level >= EVOLUTION_RULES[i]) stageIndex = i + 1; }
            if (stageIndex >= pathImages.length) stageIndex = pathImages.length - 1;
            let media = pathImages[stageIndex] || "â“";
            let title = pathTitles[stageIndex] || `${pathKey} (é˜¶${stageIndex+1})`;
            let styleClass = ""; if (stageIndex >= 2) styleClass = "mid"; if (stageIndex >= 4) styleClass = "high";
            let htmlContent = '';
            if (media.match(/\.(jpeg|jpg|gif|png|webp)$/i) || media.startsWith('http')) {
                htmlContent = `<img src="${media}" class="pet-avatar" alt="pet" onerror="this.onerror=null;this.parentNode.innerHTML='<span class=\\'pet-avatar\\'>ğŸ¥š</span>';">`;
            } else { htmlContent = `<span class="pet-avatar">${media}</span>`; }
            return { html: htmlContent, raw: media, title: title, class: styleClass, pathName: pathKey };
        }

        function changeStudentPath(path) {
            if (!currentDetailName) return;
            const idx = students.findIndex(s => s.name === currentDetailName);
            if (idx !== -1) {
                students[idx].petPath = path;
                saveData(); isDataDirty = true;
                openStudentDetail(currentDetailName); renderMainTable();
            }
        }
// ================= é”å±é€»è¾‘ =================
        // è§¦å‘é”å±
        function lockScreen() {
            // å¦‚æœè¿˜æ²¡è®¾å¯†ç ï¼Œæç¤ºå»Excelè®¾ï¼Œæˆ–è€…å…è®¸ç”¨æˆ·ç›´æ¥åœ¨ä¿®æ”¹é¡µè®¾ï¼ˆçœ‹ä½ éœ€æ±‚ï¼Œè¿™é‡Œä¿æŒä¸¥è°¨ï¼Œå…ˆè®¾å†é”ï¼‰
            if (!CONFIG.password) {
                // å¦‚æœæ˜¯ç©ºå¯†ç ï¼Œç›´æ¥è·³è½¬åˆ°ä¿®æ”¹é¢æ¿ï¼Œè®©ç”¨æˆ·è®¾åˆå§‹å¯†ç 
                document.getElementById('lockScreenOverlay').style.display = 'flex';
                // è‡ªåŠ¨åˆ‡æ¢åˆ°ä¿®æ”¹é¡µ
                const tabs = document.querySelectorAll('.lock-tab-item');
                switchLockTab('change', tabs[1]); 
                return;
            }
            
            // æ­£å¸¸é”å±ï¼Œé»˜è®¤æ˜¾ç¤ºè§£é”é¡µ
            document.getElementById('unlockPwd').value = '';
            document.getElementById('oldPwdChange').value = '';
            document.getElementById('newPwdChange').value = '';
            
            document.getElementById('lockScreenOverlay').style.display = 'flex';
            
            // é‡ç½®å›è§£é”Tab
            const tabs = document.querySelectorAll('.lock-tab-item');
            switchLockTab('unlock', tabs[0]);
        }
		
		// åˆ‡æ¢ Tab
        function switchLockTab(mode, tabEl) {
            // æ ·å¼åˆ‡æ¢
            document.querySelectorAll('.lock-tab-item').forEach(el => el.classList.remove('active'));
            tabEl.classList.add('active');
            
            // å†…å®¹åˆ‡æ¢
            document.querySelectorAll('.lock-content').forEach(el => el.classList.remove('active'));
            document.getElementById(`panel-${mode}`).classList.add('active');
        }

        // æ‰§è¡Œè§£é”
        function checkUnlock() {
            const input = document.getElementById('unlockPwd').value;
            // å…¼å®¹ String æ¯”å¯¹
            if (String(input) === String(CONFIG.password)) {
                document.getElementById('lockScreenOverlay').style.display = 'none';
            } else {
                alert("âŒ å¯†ç é”™è¯¯");
                document.getElementById('unlockPwd').value = '';
                document.getElementById('unlockPwd').focus();
            }
        }

		 // æ‰§è¡Œä¿®æ”¹å¯†ç 
        function doChangePassword() {
            const oldPwd = document.getElementById('oldPwdChange').value.trim();
            const newPwd = document.getElementById('newPwdChange').value.trim();

            if (!newPwd) return alert("âŒ æ–°å¯†ç ä¸èƒ½ä¸ºç©º");

            // éªŒè¯æ—§å¯†ç  (å¦‚æœæœ¬æ¥å°±æ²¡å¯†ç ï¼Œåˆ™å…è®¸ç›´æ¥è®¾)
            if (CONFIG.password && String(oldPwd) !== String(CONFIG.password)) {
                return alert("âŒ æ—§å¯†ç é”™è¯¯ï¼æ— æ³•ä¿®æ”¹ã€‚");
            }

            // ä¿®æ”¹å¹¶ä¿å­˜
            CONFIG.password = newPwd;
            saveData(); 
            // =========== æ ¸å¿ƒä¿®å¤åœ¨è¿™é‡Œ ===========
            isDataDirty = true;  // æ ‡è®°æ•°æ®ä¸ºâ€œè„æ•°æ®â€ï¼Œè¿™æ ·å…³é—­ç½‘é¡µæ—¶å°±ä¼šæŠ¥è­¦äº†
            // ======================================
            alert("âœ… å¯†ç ä¿®æ”¹æˆåŠŸï¼è¯·ç‰¢è®°æ–°å¯†ç ã€‚");
            
            // ä¿®æ”¹æˆåŠŸåï¼Œè‡ªåŠ¨æ¸…ç©ºè¾“å…¥æ¡†å¹¶åˆ‡å›è§£é”é¡µ
            document.getElementById('oldPwdChange').value = '';
            document.getElementById('newPwdChange').value = '';
            document.getElementById('unlockPwd').value = '';
            
            const tabs = document.querySelectorAll('.lock-tab-item');
            switchLockTab('unlock', tabs[0]); // åˆ‡å›è§£é”é¡µï¼Œè®©ç”¨æˆ·ç”¨æ–°å¯†ç è§£ä¸€æ¬¡ï¼Œä½“éªŒé—­ç¯
        }

        window.onload = function() {
            const savedData = localStorage.getItem('petGameData');
            if (savedData) {
                const parsed = JSON.parse(savedData);
                students = parsed.students || [];
                // å…¼å®¹æ—§æ•°æ®
                students.forEach(s => { if (s.currentPoints === undefined || s.currentPoints === null) s.currentPoints = s.totalPoints || 0; });
                historyData = parsed.history || [];
                products = parsed.products || [];
                
                // --- å…³é”®ä¿®æ”¹ï¼šè¯»å–é…ç½®å¹¶å¤„ç†å¯†ç  ---
                if(parsed.config) {
                    CONFIG = parsed.config;
                    // ã€è¡¥ä¸ã€‘å¦‚æœæ—§ç¼“å­˜é‡Œæ²¡æœ‰å¯†ç å­—æ®µï¼Œæˆ–è€…å¯†ç ä¸ºç©ºï¼Œå¼ºåˆ¶è®¾ä¸º "888888"
                    if (!CONFIG.password) {
                        CONFIG.password = "888888"; 
                        isDataDirty = true; // æ ‡è®°æ•°æ®å·²ä¿®æ”¹ï¼Œä¸‹æ¬¡ä¿å­˜æ—¶å†™å…¥
                    }
                }
                
                if(parsed.subjects) SUBJECT_LIST = parsed.subjects;
                if(parsed.library) PET_LIBRARY = parsed.library; 
                if(parsed.rules) EVOLUTION_RULES = parsed.rules;
                if(parsed.title) docTitle = parsed.title;
                document.getElementById('mainTitle').innerText = `ğŸ”¥ ${docTitle} èŒå® å…»æˆ`;
                refreshUI();

                // --- è‡ªåŠ¨é”å±é€»è¾‘ ---
                // åªè¦æœ‰å¯†ç ï¼ˆä¸Šé¢å·²ç»å¼ºåˆ¶è®¾äº†888888ï¼‰ï¼Œå°±é”å±
                if (CONFIG.password) {
                    lockScreen(); // ç›´æ¥è°ƒç”¨é”å±å‡½æ•°
                }
            } else { 
                initDemoData(); 
                // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡åˆå§‹åŒ–ï¼Œä¹Ÿé”å±
                if(CONFIG.password) lockScreen();
            }
            
            // æ¯æ¬¡åˆ·æ–°éƒ½é‡ç½®è„æ•°æ®æ ‡è®°ï¼Œé˜²æ­¢è¯¯æŠ¥
            setTimeout(() => { isDataDirty = false; }, 500); 
            
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('batchDate').value = today;
            document.getElementById('singleDate').value = today;
        };
        

        function initDemoData() {
            students = [{ name: "ç¤ºä¾‹åŒå­¦", level: 1, exp: 0, totalPoints: 0, currentPoints: 0, petPath: "default" }];
            products = [{ name: "å…ä½œä¸šå¡", price: 500, icon: "ğŸŸï¸" }, { name: "æ©¡çš®æ“¦", price: 50, icon: "âœï¸" }, { name: "æ£’æ£’ç³–", price: 100, icon: "ğŸ­" }];
            historyData = [];
            saveData(); refreshUI();
        }

        function saveData() {
            const data = { students, history: historyData, config: CONFIG, subjects: SUBJECT_LIST, title: docTitle, library: PET_LIBRARY, rules: EVOLUTION_RULES, products };
            localStorage.setItem('petGameData', JSON.stringify(data));
        }

        // 2. ä¿®æ”¹ UI åˆ·æ–°æ˜¾ç¤º (æ‰¾åˆ°åŸæ¥çš„ refreshUI æ›¿æ¢)
        function refreshUI() {
            renderRankingList(); 
            renderMainTable(); 
            renderSubjectDropdowns(); 
            // æ›´æ–°é¡¶éƒ¨æ˜¾ç¤ºçš„é…ç½®ä¿¡æ¯
            document.getElementById('configDisplay').innerText = `[1çº§=${CONFIG.pointsPerLevel}ç»éªŒ | 1åˆ†=${CONFIG.expRate}ç»éªŒ / ${CONFIG.pointRate}ç§¯åˆ†]`;
        }

        function renderSubjectDropdowns() {
            const ids = ['singleSubject', 'batchSubject'];
            ids.forEach(id => {
                const select = document.getElementById(id);
                select.innerHTML = '';
                SUBJECT_LIST.forEach(sub => {
                    const opt = document.createElement('option');
                    opt.value = sub; opt.textContent = sub; select.appendChild(opt);
                });
            });
        }

        // 3. ä¿®æ”¹æ ¸å¿ƒåŠ åˆ†é€»è¾‘ (æ›¿æ¢åŸæ¥çš„ addPoints)
        function addPoints(studentIndex, score, subject, dateStr, isDirectPoints = false) {
            const student = students[studentIndex];
            
            let pointsChange = 0;
            let expChange = 0;
            let recordScore = 0; // è®°å½•åœ¨æ—¥å¿—é‡Œçš„åŸå§‹åˆ†æ•°

            if (isDirectPoints) {
                // æƒ…å†µAï¼šå•†åŸå…‘æ¢æˆ–ç›´æ¥æ‰£ç§¯åˆ† (ä¸æ¶‰åŠç»éªŒï¼Œç›´æ¥æ‰£æ•°å€¼)
                pointsChange = parseInt(score); // è¿™é‡Œçš„ score é€šå¸¸æ˜¯è´Ÿæ•°
                expChange = 0; 
                recordScore = pointsChange;
            } else {
                // æƒ…å†µBï¼šæ—¥å¸¸æ‰“åˆ† (åº”ç”¨åŒé‡æ¯”ä¾‹)
                const rawScore = parseInt(score);
                recordScore = rawScore;

                // 1. è®¡ç®—ç§¯åˆ†å˜åŠ¨ (å…è®¸è´Ÿæ•°)
                pointsChange = Math.floor(rawScore * CONFIG.pointRate);

                // 2. è®¡ç®—ç»éªŒå˜åŠ¨ (ç»éªŒåªå¢ä¸å‡ï¼Œé™¤éæ˜¯æ’¤é”€)
                // å¦‚æœåˆ†æ•°æ˜¯æ­£çš„ï¼ŒåŠ ç»éªŒï¼›å¦‚æœåˆ†æ•°æ˜¯è´Ÿçš„(æƒ©ç½š)ï¼Œç»éªŒå˜åŠ¨ä¸º0
                if (rawScore > 0) {
                    expChange = Math.floor(rawScore * CONFIG.expRate);
                } else {
                    expChange = 0; 
                }
            }

            // --- æ‰§è¡Œå˜åŠ¨ ---
            
            // æ›´æ–°ç§¯åˆ†
            if(student.currentPoints === undefined) student.currentPoints = 0;
            student.currentPoints += pointsChange; 

            // æ›´æ–°ç»éªŒå’Œç­‰çº§
            if (expChange > 0) {
                student.exp += expChange;
                student.totalPoints = (student.totalPoints || 0) + expChange;
                // å‡çº§å¾ªç¯
                while (student.exp >= CONFIG.pointsPerLevel) {
                    student.exp -= CONFIG.pointsPerLevel;
                    student.level += 1;
                }
            }

            // è®°å½•æ—¥å¿—
            const formattedTime = formatAnyTime(dateStr || new Date());
            historyData.unshift({
                time: formattedTime, 
                name: student.name,
                subject: subject, 
                score: recordScore, 
                expChange: expChange,
                pointsChange: pointsChange,
                revoked: false
            });
            
            isDataDirty = true;
            return pointsChange;
        }

        // æ ¸å¿ƒæ’¤é”€é€»è¾‘ (ä¸¥æ ¼å›æ»š+é™çº§)
        function revokeHistoryItem(index) {
            const record = historyData[index];
            if (!record || record.revoked) return;

            if (!confirm(`âš ï¸ ç¡®å®šè¦æ’¤é”€è¿™æ¡è®°å½•å—ï¼Ÿ\n\n[${record.time}] ${record.name}\n${record.subject}: ${record.pointsChange > 0 ? '+' : ''}${record.pointsChange}ç§¯åˆ†\n\næ’¤é”€å°†è‡ªåŠ¨å›é€€ç§¯åˆ†å’Œç»éªŒï¼Œå¦‚æœç»éªŒä¸è¶³å°†è‡ªåŠ¨é™çº§ã€‚`)) return;

            const idx = students.findIndex(s => s.name === record.name);
            if (idx === -1) return alert("æ‰¾ä¸åˆ°è¯¥å­¦ç”Ÿï¼Œæ— æ³•æ’¤é”€");

            const student = students[idx];

            // 1. å›æ»šç§¯åˆ† (å‡å»å½“æ—¶çš„å˜åŠ¨)
            // ä¾‹å­ï¼šå½“æ—¶+50ï¼Œç°åœ¨å‡50ã€‚å½“æ—¶-500ï¼Œç°åœ¨å‡-500(å³åŠ 500)ã€‚
            student.currentPoints -= record.pointsChange;

            // 2. å›æ»šç»éªŒ (ä¸¥æ ¼é™çº§é€»è¾‘)
            if (record.expChange > 0) {
                student.exp -= record.expChange;
                student.totalPoints -= record.expChange;

                // å¾ªç¯é™çº§å¤„ç†
                while (student.exp < 0) {
                    if (student.level > 1) {
                        student.level -= 1;
                        student.exp += CONFIG.pointsPerLevel;
                    } else {
                        // å·²ç»1çº§äº†è¿˜åœ¨æ‰£ï¼Œé”æ­»åœ¨0
                        student.exp = 0;
                        break;
                    }
                }
            }

            // 3. æ ‡è®°ä¸ºå·²æ’¤é”€
            record.revoked = true;
            
            saveData();
            refreshUI();
            
            // åˆ·æ–°å¯èƒ½æ‰“å¼€çš„å¼¹çª—
            if(document.getElementById('logModal').style.display === 'flex') openLogModal();
            if(document.getElementById('detailModal').style.display === 'flex') openStudentDetail(student.name);

            showToast("ğŸ—‘ï¸ è®°å½•å·²æ’¤é”€å¹¶å›æ»š");
        }

        function renderRankingList() {
            const listEl = document.getElementById('rankingList');
            listEl.innerHTML = '';
            const sorted = [...students].sort((a, b) => b.totalPoints - a.totalPoints);
            sorted.slice(0, 10).forEach((stu, index) => {
                const div = document.createElement('div');
                div.className = `student-card`;
                div.onclick = () => openStudentDetail(stu.name);
                let rankClass = index < 3 ? `rank-${index+1}` : '';
                div.innerHTML = `<div class="rank-badge ${rankClass}">${index + 1}</div><div class="card-info"><div class="card-name">${stu.name}</div></div><div class="card-score">${stu.totalPoints}</div>`;
                listEl.appendChild(div);
            });
        }

        function renderMainTable() {
            const tbody = document.getElementById('mainTableBody');
            const term = document.getElementById('searchInput').value.toLowerCase();
            tbody.innerHTML = '';
            const sorted = [...students].sort((a, b) => b.totalPoints - a.totalPoints);
            sorted.forEach((stu, index) => {
                if (term && !stu.name.toLowerCase().includes(term)) return;
                const pet = getPetInfo(stu);
                const percent = Math.min(100, (stu.exp / CONFIG.pointsPerLevel) * 100);
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td style="font-weight:bold;">${stu.name}</td>
                    <td>${pet.html}<span class="status-tag ${pet.class}">${pet.title}</span></td>
                    <td style="padding: 8px 15px;">
                        <div style="width:120px; height:8px; background:#FFE0B2; border-radius:4px; overflow:hidden; margin: 0 auto 6px auto;">
                            <div style="width:${percent}%; height:100%; background:linear-gradient(90deg, #FF8A65, #FF5252);"></div>
                        </div>
                        <div style="font-size: 13px; color: #5D4037;"><span style="font-weight:900; color:#FF8A65; margin-right:5px;">Lv.${stu.level}</span><span style="color:#8D6E63; font-family: monospace;">${stu.exp}/${CONFIG.pointsPerLevel}</span></div>
                    </td>
                    <td style="color:#FF8A65; font-weight:900; font-size:16px;">ğŸª™ ${stu.currentPoints === undefined ? stu.totalPoints : stu.currentPoints}</td>
                    <td style="display: flex; gap: 5px; justify-content: center; align-items: center; border-bottom: 1px solid #FFF3E0; padding: 12px 15px;">
                        <button class="action-btn btn-detail" onclick="openStudentDetail('${stu.name}')">è¯¦æƒ…</button>
                        <button class="action-btn btn-feed" onclick="openSingleFeed('${stu.name}')">å–‚å…»</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // ================== æœ€ç»ˆä¿®æ”¹ç‰ˆï¼šæ“ä½œæ—¥å¿—é€»è¾‘ ==================

        // æ‰“å¼€å…¨æ ¡æ“ä½œæ—¥å¿—å¼¹çª—
        function openLogModal() {
            const modal = document.querySelector('#logModal .modal');
            // 1. è®¾ç½®å¼¹çª—å¤§å°
            modal.className = "modal modal-normal"; 
            modal.style.width = "850px";            
            modal.style.height = "85vh";        
            modal.style.maxHeight = "85vh";

            const container = document.getElementById('logListContainer');
            
            // --- å…³é”®ä¿®æ”¹å¼€å§‹ï¼šå¼ºåˆ¶å»é™¤å¤–å±‚æ»šåŠ¨æ¡ï¼Œä½¿ç”¨Flexå¸ƒå±€ ---
            container.style.overflow = "hidden";       // ğŸš« ç¦æ­¢å¤–å±‚æ»šåŠ¨
            container.style.display = "flex";          // âœ¨ å¯ç”¨Flexå¸ƒå±€
            container.style.flexDirection = "column";  // â¬‡ï¸ å‚ç›´æ’åˆ—
            container.style.height = "100%";           // ğŸ“ å æ»¡é«˜åº¦
            // --- å…³é”®ä¿®æ”¹ç»“æŸ ---

            // 2. æ„å»ºç•Œé¢ (æ³¨æ„ä¸‹é¢é‚£ä¸ªè¡¨æ ¼å®¹å™¨ div å»æ‰äº† height: calc... æ”¹ä¸ºäº† flex: 1)
            container.innerHTML = `
                <div style="display: flex; align-items: center; margin-bottom: 10px; gap: 10px; background:#FFFBF7; padding:8px; border-radius:8px; border:1px dashed #FFCCBC; flex-shrink: 0;">
                    <div style="flex:1;">
                        <input type="text" id="logSearchName" class="form-input" 
                               style="height: 36px; font-size: 13px; width: 100%;" 
                               placeholder="ğŸ” æœå§“å..." oninput="renderLogTable()">
                    </div>
                    <div style="position: relative;">
                        <input type="date" id="logSearchDate" class="form-input" 
                               style="height: 36px; font-size: 13px; width: 130px; cursor: pointer;" 
                               onchange="renderLogTable()" 
                               onclick="try{this.showPicker()}catch(e){}">
                    </div>
                    <button onclick="document.getElementById('logSearchName').value='';document.getElementById('logSearchDate').value='';renderLogTable()" 
                            style="height: 36px; padding: 0 15px; border-radius: 8px; border: 1px solid #FFCCBC; background: white; color: #FF7043; cursor: pointer; font-size: 13px; white-space:nowrap;">
                        é‡ç½®
                    </button>
                </div>
                <!-- ä¿®æ”¹è¿™é‡Œï¼šstyle="flex: 1" è®©å®ƒè‡ªåŠ¨å æ»¡å‰©ä½™ç©ºé—´ï¼Œä¸äº§ç”ŸåŒæ»šåŠ¨æ¡ -->
                <div style="flex: 1; overflow-y: auto; border: 1px solid #FFEEE4; border-radius: 12px; min-height: 0;">
                    <table class="data-table" style="width:100%">
                        <thead style="position: sticky; top: 0; z-index: 10;">
                            <tr>
                                <th width="100">æ—¶é—´</th>
                                <th width="100">å§“å</th>
                                <th>äº‹é¡¹</th>
                                <th>å˜åŠ¨</th>
                                <th width="80">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="logTableBody"></tbody>
                    </table>
                </div>
            `;
            
            renderLogTable();
            document.getElementById('logModal').style.display = 'flex';
        }

        // æ¸²æŸ“æ—¥å¿—è¡¨æ ¼
        function renderLogTable() {
            const tbody = document.getElementById('logTableBody');
            const searchName = document.getElementById('logSearchName').value.trim().toLowerCase();
            const searchDate = document.getElementById('logSearchDate').value; 

            tbody.innerHTML = '';

            const filteredData = historyData.map((item, index) => ({...item, originalIndex: index}))
                .filter(h => {
                    // å§“åç­›é€‰
                    if (searchName && !h.name.toLowerCase().includes(searchName)) return false;
                    // æ—¥æœŸç­›é€‰
                    if (searchDate && !h.time.startsWith(searchDate)) return false;
                    return true;
                });

            if (filteredData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="color: #999; padding: 20px;">æ²¡æœ‰æ‰¾åˆ°ç›¸å…³è®°å½•</td></tr>';
                return;
            }

            filteredData.forEach(h => {
                const tr = document.createElement('tr');
                if (h.revoked) tr.classList.add('revoked');

                let changeText = '';
                if (h.expChange > 0) changeText += `<span style="font-size:12px; color:#795548; margin-right:5px;">Exp+${h.expChange}</span>`;
                if (h.pointsChange !== 0) {
                    const color = h.pointsChange > 0 ? '#2E7D32' : '#C62828';
                    const sign = h.pointsChange > 0 ? '+' : '';
                    changeText += `<span style="font-weight:bold; color:${color}; font-size:13px;">ğŸª™${sign}${h.pointsChange}</span>`;
                }

                const timeParts = h.time.split(' ');
                const dateStr = timeParts[0] || h.time;
                const timeStr = timeParts[1] || '';
                
                const timeDisplay = `
                    <div style="line-height: 1.1;">
                        <div style=" font-size: 13px;">${dateStr}</div>
                        <div style="font-size:13px; ">${timeStr}</div>
                    </div>`;

                tr.innerHTML = `
                    <td style="padding: 6px 10px;">${timeDisplay}</td>
                    <td style="font-size:14px;">${h.name}</td>
                    <td style="font-size:13px;">${h.subject}</td>
                    <td>${changeText}</td>
                    <td>
                        ${h.revoked 
                            ? '<span style="color:#ccc; font-size:13px;">å·²æ’¤é”€</span>' 
                            : `<button class="btn-revoke" onclick="revokeHistoryItem(${h.originalIndex})" style="margin:0; padding: 6px 15px; font-size: 13px;">æ’¤é”€</button>`}
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

         function openStudentDetail(name) {
            currentDetailName = name;
            const student = students.find(s => s.name === name);
            if (!student) return;
            const pet = getPetInfo(student);
            const percent = (student.exp / CONFIG.pointsPerLevel) * 100;
            const historyWithIdx = historyData.map((h, i) => ({...h, originalIndex: i})).filter(h => h.name === student.name);
            
            // å¼¹çª—å°ºå¯¸è®¾ç½®
            const modal = document.querySelector('#detailModal .modal');
            modal.style.width = "900px";
            modal.style.height = "80vh";
            modal.style.maxHeight = "80vh";
            
            const contentContainer = document.getElementById('modalDetailContent');
            contentContainer.style.height = "calc(100% - 50px)";
            contentContainer.style.overflow = "hidden"; 
            contentContainer.style.padding = "0"; 

            document.getElementById('modalTitleText').innerHTML = `${student.name} <span class="badge-small">Lv.${student.level} ${pet.title}</span>`;
            
            let bigImg = pet.html.replace('class="pet-avatar"', 'class="pet-stage-lg" onclick="this.style.transform=\'scale(1.1)\'; setTimeout(()=>this.style.transform=\'scale(1)\', 200);"');
            if(!bigImg.includes('img')) bigImg = `<div class="pet-stage-lg" style="font-size:140px; display:flex; align-items:center; justify-content:center; height:100%;">${pet.raw}</div>`;

            // è¡¨æ ¼æ„å»º
            let historyRows = historyWithIdx.map(h => {
                let pChange = h.pointsChange !== undefined ? h.pointsChange : h.points;
                let eChange = h.expChange;
                if (eChange === undefined) eChange = (pChange > 0) ? pChange : 0;
                
                const color = pChange >= 0 ? '#2E7D32' : '#C62828';
                const timeParts = h.time.split(' ');
                const timeDisplay = `<div style="font-size:12px; color:#666;">${timeParts[0]}</div><div style="font-size:10px; color:#999;">${timeParts[1] || ''}</div>`;

                let changeHtml = '';
                if(eChange > 0) changeHtml += `<div style="font-size:11px; color:#795548;">Exp+${eChange}</div>`;
                changeHtml += `<div style="font-weight:bold; color:${color}; font-size:13px;">ğŸª™${pChange >= 0 ? '+' : ''}${pChange}</div>`;

                const actionHtml = h.revoked 
                    ? '<span style="color:#ccc; font-size:12px;">å·²æ’¤é”€</span>' 
                    : `<button class="btn-revoke" onclick="revokeHistoryItem(${h.originalIndex})">æ’¤é”€</button>`;

                const rowStyle = h.revoked ? 'opacity: 0.6; text-decoration: line-through;' : '';

                return `
                <tr style="border-bottom: 1px dashed #FFEEE4; ${rowStyle}">
                    <td style="padding: 10px 6px; text-align:center;">${timeDisplay}</td>
                    <td style="padding: 10px 6px; text-align:center; font-size:14px; color:#5D4037;">${h.subject}</td>
                    <td style="padding: 10px 6px; text-align:center;">${changeHtml}</td>
                    <td style="padding: 10px 6px; text-align:center;">${actionHtml}</td>
                </tr>`;
            }).join('');

            if(!historyRows) historyRows = '<tr><td colspan="4" style="text-align:center; color:#ccc; padding:40px;">æš‚æ— å–‚å…»è®°å½•</td></tr>';
            
            const tableHtml = `<table style="width:100%; border-collapse: collapse;"><tbody>${historyRows}</tbody></table>`;
            
            let petOptions = '';
            for(let key in PET_LIBRARY) {
                let label = key === 'default' ? 'é»˜è®¤ä½“ç³»' : (PET_LIBRARY[key].titles && PET_LIBRARY[key].titles[4] ? PET_LIBRARY[key].titles[4] : key);
                petOptions += `<option value="${key}" ${student.petPath === key ? 'selected' : ''}>${label}</option>`;
            }

            // å¸ƒå±€æ¸²æŸ“
            contentContainer.innerHTML = `
                <div style="display: flex; width: 100%; height: 100%; gap: 20px; box-sizing: border-box; padding: 10px;">
                    
                    <!-- å·¦ä¾§ï¼šå·²ä¿®å¤ CSSï¼Œå¼ºåˆ¶ç¦æ­¢æ¨ªå‘æ»šåŠ¨ -->
                    <div style="flex: 0 0 300px; display: flex; flex-direction: column; align-items: center; overflow-x: hidden; overflow-y: auto; box-sizing: border-box; padding-right: 5px;">
                        
                        <div class="pet-image-container" style="margin-top: 0; aspect-ratio: 1/1; width: 100%; max-width: 280px; box-sizing: border-box;">${bigImg}</div>

                        <div style="width: 100%; padding: 0 5px; box-sizing: border-box;">
                            <div class="setting-box" style="margin-bottom: 15px; background:#FFFBF7; width: 100%; box-sizing: border-box;">
                                <div style="font-weight:bold; color:#FF6B6B; font-size:13px; margin-bottom:6px;">ğŸ”® æˆé•¿ä½“ç³»</div>
                                <select onchange="changeStudentPath(this.value)" class="form-input" style="width:100%; height:40px; line-height:40px; padding:0 10px;">${petOptions}</select>
                            </div>

                            <div class="exp-container" style="background:#FFFBF7; width: 100%; box-sizing: border-box;">
                                <div style="display:flex; justify-content:space-between; font-size:13px; color:#6D4C41; margin-bottom:6px;">
                                    <strong>å½“å‰ç­‰çº§ Lv.${student.level}</strong>
                                    <span>${student.exp} / ${CONFIG.pointsPerLevel}</span>
                                </div>
                                <div class="exp-bar-bg" style="height:16px; border-radius:8px;">
                                    <div class="exp-bar-fill" style="width: ${percent}%;"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- å³ä¾§ -->
                    <div style="flex: 1; border: 2px solid #FFEEE4; border-radius: 16px; background: #fff; display: flex; flex-direction: column; overflow: hidden; height: 100%; box-shadow: 0 4px 12px rgba(0,0,0,0.03);">
                        <div style="background: #FFF3E0; padding: 12px 20px; font-weight:bold; color:#E65100; font-size:15px; border-bottom:2px solid #FFEEE4; flex-shrink: 0; display:flex; justify-content:space-between;">
                            <span>ğŸ“… å–‚å…»è®°å½•</span>
                            <span style="font-size:12px; color:#FF8A65; font-weight:normal;">å…± ${historyWithIdx.length} æ¡</span>
                        </div>
                        <div style="flex: 1; overflow-y: auto; padding: 0;">
                            ${tableHtml}
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('detailModal').style.display = 'flex';
        }

        function showLevelUpModal(idx) {
            const stu = students[idx];
            const pet = getPetInfo(stu);
            document.getElementById('levelUpName').innerText = stu.name;
            document.getElementById('levelUpTitle').innerText = pet.title;
            let bigImgHtml = pet.html;
            if(bigImgHtml.includes('<img')) {
                bigImgHtml = bigImgHtml.replace('class="pet-avatar"', 'style="width:300px; height:300px; object-fit:contain; filter:drop-shadow(0 5px 10px rgba(0,0,0,0.2));"');
            } else {
                bigImgHtml = bigImgHtml.replace('class="pet-avatar"', 'style="font-size:120px;"');
            }
            document.getElementById('levelUpImgContainer').innerHTML = bigImgHtml;
            document.getElementById('levelUpModal').style.display = 'flex';
        }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }

        function openBatchModal() {
            if (students.length === 0) return alert("è¯·å…ˆå¯¼å…¥åå•");
            const table = document.querySelector('#batchModal .data-table');
            table.querySelector('thead').innerHTML = `<tr><th style="width: 20%;">å§“å</th><th style="width: 20%;">å½“å‰ç§¯åˆ†</th><th style="width: 20%;">æˆç»©/è¡¨ç°</th><th style="width: 20%;">ç»éªŒ</th><th style="width: 20%;">ç§¯åˆ†</th></tr>`;
            const tbody = document.getElementById('batchTableBody');
            tbody.innerHTML = '';
            students.forEach((stu, idx) => {
                const cp = stu.currentPoints === undefined ? (stu.totalPoints || 0) : stu.currentPoints;
                const tr = document.createElement('tr');
                tr.innerHTML = `<td style="font-weight:bold;">${stu.name}</td><td style="color:#FF8A65; font-weight:bold;">ğŸª™ ${cp}</td><td><input type="tel" class="batch-input score-input form-input" data-name="${stu.name}" data-idx="${idx}" oninput="this.value = this.value.replace(/[^0-9-]/g, '')" placeholder="0" style="width: 80px !important;"></td><td id="prev-exp-${idx}" style="color:#ccc; font-size:13px; font-weight:bold;">-</td><td id="prev-points-${idx}" style="color:#ccc; font-size:13px; font-weight:bold;">-</td>`;
                tbody.appendChild(tr);
            });
            document.getElementById('batchModal').style.display = 'flex';
            setTimeout(() => { const i = document.querySelector('.score-input'); if(i) i.focus(); }, 300);
            const scoreInputs = document.querySelectorAll('.score-input');
            scoreInputs.forEach((input, index) => {
                input.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const nextInput = scoreInputs[index + 1];
                        if (nextInput) nextInput.focus();
                    }
                });
            });
        }

        function submitBatchFeed() {
            const inputs = document.querySelectorAll('.score-input');
            const sub = document.getElementById('batchSubject').value;
            const dateVal = document.getElementById('batchDate').value;
            
            // --- æ—¶é—´å¤„ç†é€»è¾‘ ---
            let fullDate = new Date();
            if(dateVal) { 
                let parts = dateVal.split('-'); 
                fullDate.setFullYear(parts[0], parts[1]-1, parts[2]); 
            }
            // ------------------

            let count = 0; let levelUpCount = 0;
            inputs.forEach(inp => {
                if(inp.value !== '') {
                    const idx = students.findIndex(s => s.name === inp.getAttribute('data-name'));
                    if(idx !== -1) { 
                        const oldLevel = students[idx].level;
                        addPoints(idx, parseInt(inp.value), sub, fullDate); 
                        count++; 
                        if (students[idx].level > oldLevel) levelUpCount++;
                    }
                }
            });
            if(count) { 
                saveData(); refreshUI(); 
                let msg = `âš¡ æˆåŠŸå½•å…¥ ${count} æ¡ï¼`;
                if (levelUpCount > 0) msg += `\nğŸ‰ æœ‰ ${levelUpCount} äººå‡çº§äº†ï¼`;
                showToast(msg); closeModal('batchModal'); 
            }
        }

        function triggerImport() {
            const fileInput = document.getElementById('importFile');
            if (!isDataDirty) { fileInput.value = ''; fileInput.click(); return; }
            const userChoice = confirm("âš ï¸ è­¦å‘Šï¼šå½“å‰æ•°æ®å·²ä¿®æ”¹ä½†æœªä¿å­˜ï¼\n\nå¦‚æœç°åœ¨å¯¼å…¥æ–°æ–‡ä»¶ï¼Œåˆšæ‰çš„æ“ä½œå°†ä¸¢å¤±ã€‚\n\nğŸŸ¢ ç‚¹å‡»ã€ç¡®å®šã€‘-> æ”¾å¼ƒä¿å­˜ï¼Œç»§ç»­å¯¼å…¥\nğŸ”´ ç‚¹å‡»ã€å–æ¶ˆã€‘-> æš‚ä¸å¯¼å…¥ï¼Œè‡ªè¡Œå»ä¿å­˜");
            if (userChoice) { fileInput.value = ''; fileInput.click(); }
        }

        // ================== æœ€ç»ˆä¿®å¤ç‰ˆå¯¼å…¥é€»è¾‘ ==================
        function handleImport(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const wb = XLSX.read(new Uint8Array(e.target.result), {type: 'array'});
                    
                    // 1. è¯»å–å­¦ç”ŸçŠ¶æ€
                    let targetSheetName = wb.SheetNames.includes("å­¦ç”ŸçŠ¶æ€") ? "å­¦ç”ŸçŠ¶æ€" : wb.SheetNames[0];
                    let targetSheet = wb.Sheets[targetSheetName];
                    let raw = XLSX.utils.sheet_to_json(targetSheet);
                    
                    if (raw.length === 0 && !targetSheet['!ref']) { alert("ç©ºè¡¨æ ¼"); return; }

                    students = raw.map(s => {
                        let name = s['å§“å'] || "æœªå‘½å";
                        return {
                            name: name,
                            level: Number(s['ç­‰çº§']) || 1,
                            exp: Number(s['ç»éªŒ']) || 0,
                            totalPoints: Number(s['æ€»ç»éªŒå€¼']) || 0,
                            currentPoints: (s['å¯ç”¨ç§¯åˆ†'] !== undefined) ? Number(s['å¯ç”¨ç§¯åˆ†']) : (Number(s['æ€»ç»éªŒå€¼']) || 0),
                            petPath: s['è·¯å¾„'] || "default"
                        };
                    }).filter(s => s.name !== "æœªå‘½å");

                    // 2. è¯»å–å–‚å…»è®°å½•
                    if(wb.Sheets["å–‚å…»è®°å½•"]) {
                        let rawHistory = XLSX.utils.sheet_to_json(wb.Sheets["å–‚å…»è®°å½•"]);
                        historyData = rawHistory.map(h => ({
                            time: formatAnyTime(h['æ—¶é—´']),
                            name: h['å§“å'],
                            subject: h['ç§‘ç›®'],
                            score: h['åˆ†æ•°'],
                            expChange: Number(h['ç»éªŒå˜åŠ¨']) || 0,
                            pointsChange: Number(h['ç§¯åˆ†å˜åŠ¨']) || 0,
                            revoked: h['å·²æ’¤é”€'] === 'æ˜¯' || h['å·²æ’¤é”€'] === true
                        }));
                    } else { historyData = []; }

                    // 3. è¯»å–å•†å“æ¸…å•
                    if(wb.Sheets["å•†å“æ¸…å•"]) {
                        let rawProd = XLSX.utils.sheet_to_json(wb.Sheets["å•†å“æ¸…å•"]);
                        products = rawProd.map(p => ({
                            name: p['å•†å“åç§°'], price: Number(p['å…‘æ¢ç§¯åˆ†']) || 0, icon: "ğŸ"
                        })).filter(p => p.name);
                    }

                    // 4. è¯»å–å® ç‰©å›¾é‰´
                    if(wb.Sheets["å® ç‰©å›¾é‰´"]) {
                        let rawLib = XLSX.utils.sheet_to_json(wb.Sheets["å® ç‰©å›¾é‰´"]);
                        let newLib = {};
                        rawLib.forEach(row => {
                            let key = row['è·¯å¾„ä»£ç '];
                            if(key) {
                                let images = [], titles = [];
                                for(let i=0; i<5; i++) {
                                    images.push(row[`é˜¶æ®µ${i}`] || "");
                                    titles.push(row[`ç§°å·${i}`] || "");
                                }
                                newLib[key] = { images: images, titles: titles };
                            }
                        });
                        if(Object.keys(newLib).length > 0) PET_LIBRARY = newLib;
                    }

                    // 5. è¯»å–é…ç½® (åŒ…å«åˆ†ç¦»çš„æ¯”ä¾‹)
                    if(wb.Sheets["é…ç½®"]) {
                        let rawConfig = XLSX.utils.sheet_to_json(wb.Sheets["é…ç½®"]);
                        rawConfig.forEach(item => {
                            if(item['é…ç½®é¡¹'] === 'ç»éªŒæ¢ç®—æ¯”ä¾‹') CONFIG.expRate = Number(item['å€¼']);
                            if(item['é…ç½®é¡¹'] === 'ç§¯åˆ†æ¢ç®—æ¯”ä¾‹') CONFIG.pointRate = Number(item['å€¼']);
                            // å…¼å®¹æ—§ç‰ˆ
                            if(item['é…ç½®é¡¹'] === 'æ¢ç®—æ¯”ä¾‹') {
                                CONFIG.expRate = Number(item['å€¼']);
                                CONFIG.pointRate = Number(item['å€¼']);
                            }
							if(item['é…ç½®é¡¹'] === 'ç®¡ç†å¯†ç ') CONFIG.password = String(item['å€¼']); // <--- åŠ è¿™ä¸€è¡Œ
                            if(item['é…ç½®é¡¹'] === 'å‡çº§ç»éªŒ') CONFIG.pointsPerLevel = Number(item['å€¼']);
                            if(item['é…ç½®é¡¹'] === 'è¿›åŒ–ç­‰çº§é—¨æ§›') EVOLUTION_RULES = String(item['å€¼']).split(',').map(Number);
                        });
                    }

                    // 6. ã€æ–°å¢ä¿®å¤ã€‘è¯»å–ç§‘ç›®è®¾ç½® (è§£å†³ç§‘ç›®æ— æ³•è‡ªå®šä¹‰çš„é—®é¢˜)
                    if(wb.Sheets["ç§‘ç›®è®¾ç½®"]) {
                        let rawSub = XLSX.utils.sheet_to_json(wb.Sheets["ç§‘ç›®è®¾ç½®"]);
                        // æå–"ç§‘ç›®"è¿™ä¸€åˆ—ï¼Œå¹¶è¿‡æ»¤æ‰ç©ºå€¼
                        let newSubs = rawSub.map(s => s['ç§‘ç›®']).filter(s => s);
                        if(newSubs.length > 0) {
                            SUBJECT_LIST = newSubs;
                        }
                    }

                    // æ›´æ–°ç•Œé¢ (docTitle, åˆ·æ–°UIä¼šé‡ç»˜ä¸‹æ‹‰èœå•)
                    docTitle = file.name.replace(/\.xlsx?$/, '');
                    document.getElementById('mainTitle').innerText = `ğŸ”¥ ${docTitle} èŒå® å…»æˆ`;
                    
                    saveData(); 
                    refreshUI(); // è¿™ä¸€æ­¥ä¼šè°ƒç”¨ renderSubjectDropdowns()ï¼Œä½ çš„æ–°ç§‘ç›®å°±ä¼šå‡ºç°äº†
                    isDataDirty = false;
                    showToast("ğŸ“‚ å¯¼å…¥æˆåŠŸï¼(åŒ…å«ç§‘ç›®è®¾ç½®)");
                    input.value = '';
                } catch (error) { 
                    console.error(error);
                    alert("å¯¼å…¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥Excelæ ¼å¼"); 
                }
            };
            reader.readAsArrayBuffer(file);
        }

        async function downloadTemplateWithPicker() {
            const wb = XLSX.utils.book_new();

            // 1. å­¦ç”ŸçŠ¶æ€ (ç¤ºä¾‹)
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet([
                { "å§“å": "ç¤ºä¾‹å­¦ç”Ÿ", "ç­‰çº§": 1, "ç»éªŒ": 0, "æ€»ç»éªŒå€¼": 0, "å¯ç”¨ç§¯åˆ†": 0, "è·¯å¾„": "xiongmao" }
            ]), "å­¦ç”ŸçŠ¶æ€");

            // 2. å–‚å…»è®°å½• (ç©ºè¡¨å¤´)
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet([
                ["æ—¶é—´", "å§“å", "ç§‘ç›®", "åˆ†æ•°", "ç»éªŒå˜åŠ¨", "ç§¯åˆ†å˜åŠ¨", "å·²æ’¤é”€"]
            ]), "å–‚å…»è®°å½•");

            // 3. é…ç½® (ä¿®å¤ï¼šæ‹†åˆ†æ¯”ä¾‹ + å¢åŠ ç®¡ç†å¯†ç )
            const configData = [
                { "é…ç½®é¡¹": "ç»éªŒæ¢ç®—æ¯”ä¾‹", "å€¼": 0.5 },
                { "é…ç½®é¡¹": "ç§¯åˆ†æ¢ç®—æ¯”ä¾‹", "å€¼": 1.0 },
                { "é…ç½®é¡¹": "å‡çº§ç»éªŒ", "å€¼": 100 },
                { "é…ç½®é¡¹": "è¿›åŒ–ç­‰çº§é—¨æ§›", "å€¼": "3,6,10,20" },
                { "é…ç½®é¡¹": "ç®¡ç†å¯†ç ", "å€¼": "888888" } // é»˜è®¤å¯†ç 
            ];
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(configData), "é…ç½®");

            // 4. ç§‘ç›®è®¾ç½® (ä¿®å¤ï¼šå¢åŠ æ›´å¤šé»˜è®¤ç§‘ç›®)
            const subjectData = [
                { "ç§‘ç›®": "è¯­æ–‡" },
                { "ç§‘ç›®": "æ•°å­¦" },
                { "ç§‘ç›®": "è‹±è¯­" },
                { "ç§‘ç›®": "æ—¥å¸¸" },
                { "ç§‘ç›®": "ä¸äº¤ä½œä¸š" },
                { "ç§‘ç›®": "ä¸Šè¯¾è¯´è¯" }
            ];
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(subjectData), "ç§‘ç›®è®¾ç½®");

            // 5. å•†å“æ¸…å•
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet([
                { "å•†å“åç§°": "å…ä½œä¸šå¡", "å…‘æ¢ç§¯åˆ†": 500 },
                { "å•†å“åç§°": "æ©¡çš®æ“¦", "å…‘æ¢ç§¯åˆ†": 50 },
                { "å•†å“åç§°": "æ£’æ£’ç³–", "å…‘æ¢ç§¯åˆ†": 100 }
            ]), "å•†å“æ¸…å•");

            // 6. å® ç‰©å›¾é‰´ (ä¿®å¤ï¼šç¡®ä¿å†™å…¥å®Œæ•´çš„å›¾ç‰‡è·¯å¾„æ•°æ®)
            const fullLibraryData = [
                { 
                    "è·¯å¾„ä»£ç ": "xiongmao", "è¯´æ˜": "åŠŸå¤«ç†ŠçŒ«", 
                    "é˜¶æ®µ0": "img/xiongmao/1.png", "ç§°å·0": "ç¿¡ç¿ é’ç«¹", 
                    "é˜¶æ®µ1": "img/xiongmao/2.png", "ç§°å·1": "åŠŸå¤«å­¦å¾’",
                    "é˜¶æ®µ2": "img/xiongmao/3.png", "ç§°å·2": "ç«¹æ—ä¾ å®¢",
                    "é˜¶æ®µ3": "img/xiongmao/4.png", "ç§°å·3": "å®—å¸ˆé£èŒƒ",
                    "é˜¶æ®µ4": "img/xiongmao/5.png", "ç§°å·4": "ç¥é¾™å°Šè€…" 
                },
                { 
                    "è·¯å¾„ä»£ç ": "jingling", "è¯´æ˜": "é­”æ³•ç²¾çµ", 
                    "é˜¶æ®µ0": "img/jingling/1.png", "ç§°å·0": "é­”æ³•ä¹‹å¿ƒ", 
                    "é˜¶æ®µ1": "img/jingling/2.png", "ç§°å·1": "æ£®æ—å¾®å…‰",
                    "é˜¶æ®µ2": "img/jingling/3.png", "ç§°å·2": "å…ƒç´ ä½¿è€…",
                    "é˜¶æ®µ3": "img/jingling/4.png", "ç§°å·3": "æœˆå…‰è´¤è€…",
                    "é˜¶æ®µ4": "img/jingling/5.png", "ç§°å·4": "æ°´æ™¶å¤©ä½¿" 
                },
                { 
                    "è·¯å¾„ä»£ç ": "linghu", "è¯´æ˜": "ç¥ˆæ„¿çµç‹", 
                    "é˜¶æ®µ0": "img/linghu/1.png", "ç§°å·0": "ç¥ˆæ„¿å®ç ", 
                    "é˜¶æ®µ1": "img/linghu/2.png", "ç§°å·1": "çµå±±å¹¼ç‹",
                    "é˜¶æ®µ2": "img/linghu/3.png", "ç§°å·2": "ä¹å°¾çµç‹",
                    "é˜¶æ®µ3": "img/linghu/4.png", "ç§°å·3": "é’ä¸˜å›½ä¸»",
                    "é˜¶æ®µ4": "img/linghu/5.png", "ç§°å·4": "ç¥¥ç‘å¤©å¥³" 
                },
                { 
                    "è·¯å¾„ä»£ç ": "renyu", "è¯´æ˜": "æ·±æµ·äººé±¼", 
                    "é˜¶æ®µ0": "img/renyu/1.png", "ç§°å·0": "æ·±æµ·çµç ", 
                    "é˜¶æ®µ1": "img/renyu/2.png", "ç§°å·1": "äººé±¼å…¬ä¸»",
                    "é˜¶æ®µ2": "img/renyu/3.png", "ç§°å·2": "æµ·æ½®æ­Œè€…",
                    "é˜¶æ®µ3": "img/renyu/4.png", "ç§°å·3": "æ·±è“å¥³çš‡",
                    "é˜¶æ®µ4": "img/renyu/5.png", "ç§°å·4": "æµ·æ´‹å¤©ä½¿" 
                },
                { 
                    "è·¯å¾„ä»£ç ": "konglong", "è¯´æ˜": "æœºç”²ç¥é¾™", 
                    "é˜¶æ®µ0": "img/konglong/1.png", "ç§°å·0": "è¿œå¤é¾™è›‹", 
                    "é˜¶æ®µ1": "img/konglong/2.png", "ç§°å·1": "æœºç”²å¹¼é¾™",
                    "é˜¶æ®µ2": "img/konglong/3.png", "ç§°å·2": "åˆé‡‘æš´é¾™",
                    "é˜¶æ®µ3": "img/konglong/4.png", "ç§°å·3": "æœºæ¢°é¢†ä¸»",
                    "é˜¶æ®µ4": "img/konglong/5.png", "ç§°å·4": "æœºç”²é¾™ç¥" 
                }
            ];
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(fullLibraryData), "å® ç‰©å›¾é‰´");

            await saveWorkbookByUser(wb, "èŒå® é…ç½®æ¨¡æ¿.xlsx");
        }
        
        // 5. ä¿®æ”¹å¯¼å‡ºé€»è¾‘ (æ›¿æ¢åŸæ¥çš„ exportDataWithPicker)
        async function exportDataWithPicker() {
            const wb = XLSX.utils.book_new();
            
            // 1. å­¦ç”ŸçŠ¶æ€
            const exportStudents = students.map(s => ({ "å§“å": s.name, "ç­‰çº§": s.level, "ç»éªŒ": s.exp, "æ€»ç»éªŒå€¼": s.totalPoints, "å¯ç”¨ç§¯åˆ†": s.currentPoints, "è·¯å¾„": s.petPath }));
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(exportStudents), "å­¦ç”ŸçŠ¶æ€");
            
            // 2. å–‚å…»è®°å½•
            const exportHistory = historyData.map(h => ({
                "æ—¶é—´": h.time, "å§“å": h.name, "ç§‘ç›®": h.subject, "åˆ†æ•°": h.score, "ç»éªŒå˜åŠ¨": h.expChange, "ç§¯åˆ†å˜åŠ¨": h.pointsChange, "å·²æ’¤é”€": h.revoked ? 'æ˜¯' : 'å¦'
            }));
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(exportHistory), "å–‚å…»è®°å½•");
            
            // 3. å•†å“æ¸…å•
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(products.map(p => ({ "å•†å“åç§°": p.name, "å…‘æ¢ç§¯åˆ†": p.price }))), "å•†å“æ¸…å•");
            
            // 4. é…ç½® (å¢åŠ é»˜è®¤å€¼ ||ï¼Œé˜²æ­¢å¯¼å‡ºä¸ºç©º)
            const configData = [ 
                { "é…ç½®é¡¹": "ç»éªŒæ¢ç®—æ¯”ä¾‹", "å€¼": (CONFIG.expRate !== undefined ? CONFIG.expRate : 0.5) }, 
                { "é…ç½®é¡¹": "ç§¯åˆ†æ¢ç®—æ¯”ä¾‹", "å€¼": (CONFIG.pointRate !== undefined ? CONFIG.pointRate : 1.0) }, 
                { "é…ç½®é¡¹": "å‡çº§ç»éªŒ", "å€¼": (CONFIG.pointsPerLevel || 100) }, 
                { "é…ç½®é¡¹": "è¿›åŒ–ç­‰çº§é—¨æ§›", "å€¼": (EVOLUTION_RULES ? EVOLUTION_RULES.join(',') : "3,6,10,20") } ,
				{ "é…ç½®é¡¹": "ç®¡ç†å¯†ç ", "å€¼": CONFIG.password || "888888" }
            ];
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(configData), "é…ç½®");
            
            // 5. ç§‘ç›®
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(SUBJECT_LIST.map(s => ({ "ç§‘ç›®": s }))), "ç§‘ç›®è®¾ç½®");
            
            // 6. å›¾é‰´
            let libraryData = [];
            for (let key in PET_LIBRARY) {
                const lib = PET_LIBRARY[key];
                let row = { "è·¯å¾„ä»£ç ": key, "è¯´æ˜": (lib.titles && lib.titles.length > 0) ? lib.titles[lib.titles.length - 1] : key };
                if (lib.images) { lib.images.forEach((img, i) => { row[`é˜¶æ®µ${i}`] = img; }); }
                if (lib.titles) { lib.titles.forEach((title, i) => { row[`ç§°å·${i}`] = title; }); }
                libraryData.push(row);
            }
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(libraryData), "å® ç‰©å›¾é‰´");

            try {
                const handle = await getExportFileHandle(`${docTitle}_å­˜æ¡£.xlsx`, wb);
                if (!handle) return; 
                await writeExcelToFile(handle, wb);
                isDataDirty = false; showToast("ğŸ’¾ å®Œæ•´å­˜æ¡£å¯¼å‡ºæˆåŠŸï¼");
            } catch (error) { console.error(error); showToast("âŒ å¯¼å‡ºå¤±è´¥"); }
        }

        async function getExportFileHandle(filename, wb) {
            try {
                if (window.showSaveFilePicker) { return await window.showSaveFilePicker({ suggestedName: filename, types: [{ description: 'Excel Files', accept: { 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': ['.xlsx'] } }] }); }
                XLSX.writeFile(wb, filename); return { traditional: true };
            } catch (err) { if (err.name === 'AbortError') return null; throw err; }
        }

        async function writeExcelToFile(handle, wb) {
            const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
            const blob = new Blob([wbout], { type: "application/octet-stream" });
            if (handle.traditional) return;
            const writable = await handle.createWritable();
            await writable.write(blob);
            await writable.close();
        }

        async function saveWorkbookByUser(wb, filename) {
            const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
            const blob = new Blob([wbout], { type: "application/octet-stream" });
            try {
                if (window.showSaveFilePicker) {
                    const handle = await window.showSaveFilePicker({ suggestedName: filename, types: [{ description: 'Excel Files', accept: { 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': ['.xlsx'] } }] });
                    const writable = await handle.createWritable(); await writable.write(blob); await writable.close(); return true;
                }
            } catch (err) { if (err.name === 'AbortError') return false; }
            XLSX.writeFile(wb, filename); return true;
        }
        
         document.addEventListener('input', function(e){
            if(e.target.classList.contains('score-input')) {
                const input = e.target;
                const scoreStr = input.value;
                const idx = input.getAttribute('data-idx'); 
                const expEl = document.getElementById(`prev-exp-${idx}`);
                const pointsEl = document.getElementById(`prev-points-${idx}`);
                
                if (expEl && pointsEl) {
                    if (scoreStr === '' || scoreStr === '-') {
                        expEl.innerText = '-'; expEl.style.color = '#ccc';
                        pointsEl.innerText = '-'; pointsEl.style.color = '#ccc';
                        return;
                    }
                    const score = parseInt(scoreStr);
                    
                    // --- ä¿®æ”¹è®¡ç®—é€»è¾‘ ---
                    // 1. ç§¯åˆ†ï¼šç›´æ¥ä¹˜ç§¯åˆ†æ¯”ä¾‹
                    const pointsChange = Math.floor(score * CONFIG.pointRate);
                    
                    // 2. ç»éªŒï¼šæ­£åˆ†ä¹˜ç»éªŒæ¯”ä¾‹ï¼Œè´Ÿåˆ†ä¸æ‰£ç»éªŒ
                    let expChange = 0;
                    if (score > 0) {
                        expChange = Math.floor(score * CONFIG.expRate);
                    }
                    // ------------------

                    // æ¸²æŸ“ç»éªŒé¢„è§ˆ
                    if (expChange > 0) { 
                        expEl.innerText = `+${expChange}`; expEl.style.color = '#2E7D32'; 
                    } else { 
                        expEl.innerText = '0'; expEl.style.color = '#ccc'; 
                    }

                    // æ¸²æŸ“ç§¯åˆ†é¢„è§ˆ
                    if (pointsChange > 0) { 
                        pointsEl.innerText = `+${pointsChange}`; pointsEl.style.color = '#2E7D32'; 
                    } else if (pointsChange < 0) { 
                        pointsEl.innerText = `${pointsChange}`; pointsEl.style.color = '#C62828'; 
                    } else { 
                        pointsEl.innerText = '0'; pointsEl.style.color = '#ccc'; 
                    }
                }
            }
        });

        function showToast(msg) {
            const toast = document.getElementById('centerToast');
            document.getElementById('toastMsg').innerText = msg;
            toast.style.display = 'block'; toast.style.opacity = '0';
            toast.animate([{opacity: 0, transform: 'translate(-50%, -40%)'}, {opacity: 1, transform: 'translate(-50%, -50%)'}], {duration: 300, fill: 'forwards'});
            if (msg !== "ğŸ“¤ æ•°æ®å¯¼å‡ºä¸­ï¼Œè¯·ç¨å€™...") setTimeout(() => { toast.style.display = 'none'; }, 2000);
        }

        function openGalleryModal() {
            const container = document.getElementById('galleryContent');
            container.innerHTML = '';
            for (let key in PET_LIBRARY) {
                const lib = PET_LIBRARY[key];
                let groupName = key === 'default' ? 'é»˜è®¤ä½“ç³»' : (lib.titles && lib.titles.length > 0 ? lib.titles[lib.titles.length - 1] : key);
                let html = `<div class="gallery-group"><div class="gallery-title">ğŸ”® ${groupName}</div><div class="gallery-row">`;
                lib.images.forEach((img, idx) => {
                    let title = lib.titles[idx] || `ç¬¬${idx}é˜¶`;
                    let needLv = idx === 0 ? 1 : (EVOLUTION_RULES[idx-1] || 'Max');
                    let imgTag = img.match(/\.(jpeg|jpg|gif|png|webp)$/i) || img.startsWith('http') ? `<img src="${img}" class="gallery-img" onclick="showBigImage('${img}')" style="cursor:zoom-in;">` : `<div class="gallery-img" style="font-size:40px; display:flex; align-items:center; justify-content:center;">${img}</div>`;
                    html += `<div class="gallery-item"><span class="gallery-level">Lv.${needLv}</span>${imgTag}<span class="gallery-name">${title}</span></div>`;
                    if (idx < lib.images.length - 1) html += `<div class="gallery-arrow">â†’</div>`;
                });
                html += `</div></div>`;
                container.innerHTML += html;
            }
            document.getElementById('galleryModal').style.display = 'flex';
        }

        function showBigImage(src) {
            const overlay = document.getElementById('imgPreviewOverlay');
            document.getElementById('imgPreviewTarget').src = src;
            overlay.style.display = 'flex';
        }

        // ================= ç§¯åˆ†å•†åŸé€»è¾‘ (åŒå‘ç‰µåˆ¶+ç›´æ¥æ‰£åˆ†æœ€ç»ˆç‰ˆ) =================
        let selectedProductIdx = -1;
        let selectedStudentNames = new Set(); 

        function openShopModal() {
            selectedProductIdx = -1; selectedStudentNames.clear(); 
            
            // 1. è®¾ç½®å¼¹çª—é«˜åº¦ä¸å›¾é‰´ä¸€è‡´
            const modal = document.querySelector('#shopModal .modal');
            modal.style.width = "850px";
            modal.style.height = "85vh";       // ç»Ÿä¸€é«˜åº¦
            modal.style.maxHeight = "85vh";

            // 2. è¿™é‡Œçš„ shop-container åŸæœ¬åœ¨ CSS é‡Œå†™æ­»äº† height: 500pxï¼Œæˆ‘ä»¬éœ€è¦ç”¨ JS è¦†ç›–å®ƒ
            // ä¸ºäº†ä¿è¯å†…éƒ¨å¸ƒå±€è‡ªé€‚åº”ï¼Œè®¾ç½®ä¸º flex:1 æˆ– 100%
            const shopContainer = document.querySelector('.shop-container');
            if(shopContainer) {
                shopContainer.style.height = "calc(100% - 50px)"; // å‡å»å¤´éƒ¨é«˜åº¦
            }

            updateBatchBtnState(); renderShopProducts(); renderShopStudents(); 
            document.getElementById('shopModal').style.display = 'flex';
        }

        function getMinPointsOfSelectedStudents() {
            if (selectedStudentNames.size === 0) return Infinity; 
            let min = Infinity;
            selectedStudentNames.forEach(name => {
                const s = students.find(stu => stu.name === name);
                if (s) { const cp = s.currentPoints !== undefined ? s.currentPoints : (s.totalPoints || 0); if (cp < min) min = cp; }
            });
            return min;
        }

        function renderShopProducts() {
            const container = document.getElementById('shopGoodsGrid');
            container.innerHTML = '';
            const minStudentPoints = getMinPointsOfSelectedStudents();
            products.forEach((p, idx) => {
                const div = document.createElement('div');
                const isTooExpensive = p.price > minStudentPoints;
                div.className = `good-card ${selectedProductIdx === idx ? 'active' : ''} ${isTooExpensive ? 'disabled' : ''}`;
                div.onclick = (e) => {
                    if(e.target.className.includes('btn-del')) return;
                    if(isTooExpensive) return; 
                    if (selectedProductIdx === idx) { selectedProductIdx = -1; } else { selectedProductIdx = idx; }
                    updateBatchBtnState(); renderShopProducts(); renderShopStudents(); 
                };
                div.innerHTML = `<span class="btn-del-good" onclick="deleteProduct(${idx})">Ã—</span><div class="good-icon">${p.icon || 'ğŸ'}</div><div class="good-name">${p.name}</div><div class="good-price">ğŸª™ ${p.price}</div>`;
                container.appendChild(div);
            });
            const addBtn = document.createElement('div');
            addBtn.className = 'good-card add-good-card';
            addBtn.innerHTML = '<span style="font-size:24px;">+</span><span style="font-size:12px;">æ·»åŠ å•†å“</span>';
            addBtn.onclick = addNewProduct;
            container.appendChild(addBtn);
        }

        function renderShopStudents() {
            const container = document.getElementById('shopStudentList');
            const term = document.getElementById('shopSearchInput').value.toLowerCase();
            container.innerHTML = '';
            const product = selectedProductIdx !== -1 ? products[selectedProductIdx] : null;
            const sorted = [...students].sort((a, b) => (b.currentPoints||0) - (a.currentPoints||0));
            sorted.forEach((stu) => {
                if (term && !stu.name.toLowerCase().includes(term)) return;
                const cp = stu.currentPoints !== undefined ? stu.currentPoints : (stu.totalPoints || 0);
                let canBuy = true;
                if (product && cp < product.price) { canBuy = false; }
                const isSelected = selectedStudentNames.has(stu.name);
                const div = document.createElement('div');
                div.className = `shop-stu-item ${!canBuy ? 'disabled' : ''} ${isSelected ? 'selected' : ''}`;
                if (canBuy) {
                    div.onclick = () => {
                        if (selectedStudentNames.has(stu.name)) { selectedStudentNames.delete(stu.name); } 
                        else { selectedStudentNames.add(stu.name); }
                        renderShopStudents(); renderShopProducts(); updateBatchBtnState();
                    };
                }
                div.innerHTML = `<div style="font-weight:bold;">${stu.name}</div><div class="shop-stu-coin" style="color:${canBuy ? '#E65100' : '#ccc'}">ğŸª™ ${cp}</div>`;
                container.appendChild(div);
            });
        }

        function updateBatchBtnState() {
            const count = selectedStudentNames.size;
            const countEl = document.getElementById('selectedCount');
            if(countEl) countEl.innerText = count;
            const btn = document.getElementById('btnBatchBuy');
            if(!btn) return;
            const product = selectedProductIdx !== -1 ? products[selectedProductIdx] : null;
            if (count > 0 && product) {
                btn.classList.add('active');
                const totalPrice = count * product.price;
                btn.innerText = `å…‘æ¢ (æ¶ˆè€— ${totalPrice})`;
            } else {
                btn.classList.remove('active');
                if (count === 0 && !product) btn.innerText = 'è¯·é€‰æ‹©å•†å“å’Œå­¦ç”Ÿ';
                else if (!product) btn.innerText = 'è¯·é€‰æ‹©å•†å“';
                else if (count === 0) btn.innerText = 'è¯·é€‰æ‹©å­¦ç”Ÿ';
                else btn.innerText = 'ç¡®è®¤å…‘æ¢';
            }
        }

        function submitBatchPurchase() {
            const product = products[selectedProductIdx];
            const names = Array.from(selectedStudentNames);
            if (!product || names.length === 0) return;
            if (!confirm(`ç¡®è®¤è¦ä¸ºè¿™ ${names.length} ä½åŒå­¦å…‘æ¢ [${product.name}] å—ï¼Ÿ\næ€»è®¡å°†æ¶ˆè€— ${names.length * product.price} ç§¯åˆ†ã€‚`)) return;
            let successCount = 0;
            names.forEach(name => {
                const idx = students.findIndex(s => s.name === name);
                if (idx !== -1) {
                    if ((students[idx].currentPoints || 0) >= product.price) {
                        addPoints(idx, -product.price, `å…‘æ¢ï¼š${product.name}`, new Date(), true);
                        successCount++;
                    }
                }
            });
            if(successCount > 0) {
                saveData();
                selectedStudentNames.clear(); selectedProductIdx = -1; 
                updateBatchBtnState(); refreshUI(); renderShopProducts(); renderShopStudents(); 
                showToast(`ğŸ‰ æˆåŠŸå…‘æ¢ ${successCount} ä¸ª [${product.name}]ï¼`);
            }
        }

        function addNewProduct() {
            document.getElementById('newProdName').value = '';
            document.getElementById('newProdPrice').value = '';
            document.getElementById('addProductModal').style.display = 'flex';
            setTimeout(() => document.getElementById('newProdName').focus(), 100);
        }

        function confirmAddProduct() {
            const name = document.getElementById('newProdName').value.trim();
            const priceVal = document.getElementById('newProdPrice').value.trim();
            if (!name) return alert("è¯·å¡«å†™å¥–å“åç§°");
            if (!priceVal || isNaN(priceVal)) return alert("è¯·å¡«å†™æœ‰æ•ˆçš„ç§¯åˆ†æ•°å€¼");
            products.push({ name: name, price: parseInt(priceVal), icon: "ğŸ" });
            saveData(); renderShopProducts(); closeModal('addProductModal'); showToast("âœ… å•†å“ä¸Šæ¶æˆåŠŸï¼");
        }

        function deleteProduct(idx) {
            if(confirm("ç¡®å®šåˆ é™¤è¿™ä¸ªå•†å“å—ï¼Ÿ")) {
                products.splice(idx, 1);
                if(selectedProductIdx === idx) selectedProductIdx = -1;
                saveData(); renderShopProducts(); renderShopStudents(); 
            }
        }
    </script>
</body>
</html>